{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load time_extras %}

{% block title %}Summary{% endblock %}

{% block content %}
<style>
    .task-action-btn[disabled],
    button[disabled] {
        opacity: 0.6 !important;
        cursor: not-allowed !important;
        pointer-events: none !important;
    }

    :root {
        --jira-blue: #0052cc;
        --jira-blue-light: #deebff;
        --jira-gray-100: #f4f5f7;
        --jira-gray-200: #ebecf0;
        --jira-gray-300: #dfe1e6;
        --jira-gray-700: #5e6c84;
        --jira-gray-900: #172b4d;
    }

    body {
        background-color: #fff;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }

    /* Header Section - Matching Board/Backlog */
    .summary-header {
        background-color: #fff;
        border-bottom: 2px solid var(--jira-gray-200);
        padding: 16px 24px;
        margin-bottom: 0;
    }

    .project-breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: var(--jira-gray-700);
        margin-bottom: 12px;
    }

    .project-breadcrumb .separator {
        color: var(--jira-gray-300);
    }

    .project-name {
        font-size: 24px;
        font-weight: 500;
        color: var(--jira-gray-900);
        margin: 0;
    }

    /* Navigation Tabs - Matching Board/Backlog */
    .summary-nav {
        display: flex;
        gap: 0;
        border-bottom: 2px solid var(--jira-gray-200);
        padding: 0 24px;
        background-color: #fff;
        margin-bottom: 24px;
    }

    .summary-nav-item {
        padding: 12px 16px;
        color: var(--jira-gray-700);
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
    }

    .summary-nav-item:hover {
        color: var(--jira-blue);
        background-color: var(--jira-gray-100);
    }

    .summary-nav-item.active {
        color: var(--jira-blue);
        border-bottom-color: var(--jira-blue);
    }

    /* Content Padding */
    .summary-content {
        padding: 0 24px 24px;
    }

    /* Enhanced Task Card Styles */
    .task-card {
        border-left: 4px solid #dee2e6;
        transition: all 0.3s ease;
        background: #fff;
    }
    
    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    }
    
    .task-card.todo-card { border-left-color: #ffc107; }
    .task-card.progress-card { border-left-color: #0d6efd; }
    .task-card.done-card { border-left-color: #198754; }
    
    /* Modern Button Styles */
    .task-action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 16px;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 8px;
        border: none;
        transition: all 0.2s ease;
        cursor: pointer;
        text-transform: none;
        gap: 6px;
        width: 100%;
    }
    
    .task-action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .task-action-btn:active {
        transform: translateY(0);
    }
    
    /* Specific Button Variants */
    .btn-move-progress {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .btn-move-progress:hover {
        background: linear-gradient(135deg, #5568d3 0%, #63408a 100%);
        color: white;
    }
    
    .btn-pause-task {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .btn-pause-task:hover {
        background: linear-gradient(135deg, #e082ea 0%, #e4465b 100%);
        color: white;
    }

    .btn-resume-task {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
    }
    
    .btn-resume-task:hover {
        background: linear-gradient(135deg, #32d86a 0%, #27e8c6 100%);
        color: white;
    }
    
    .btn-move-done {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }
    
    .btn-move-done:hover {
        background: linear-gradient(135deg, #3e9bed 0%, #00e1ed 100%);
        color: white;
    }
    
    .btn-back-progress {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
    }
    
    .btn-back-progress:hover {
        background: linear-gradient(135deg, #e95f89 0%, #edd02f 100%);
        color: white;
    }
    
    /* Button Icons */
    .task-action-btn i {
        font-size: 1rem;
    }
    
    /* Action Buttons Container */
    .task-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #e9ecef;
    }
    
    /* Task Info Styles */
    .task-info {
        font-size: 0.875rem;
        color: #6c757d;
        margin: 8px 0;
    }
    
    .task-info strong {
        color: #495057;
    }
    
    /* Column Headers */
    .kanban-column-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 16px;
        padding: 14px 12px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 8px;
        font-weight: 600;
        min-height: 50px;
        height: 50px;
        font-size: 1rem;
    }

    .kanban-column-header.todo { 
        background: linear-gradient(135deg, #ffe07b 0%, #ffad14 100%); 
        color: white;
    }

    .kanban-column-header.progress { 
        background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); 
        color: white; 
    }

    .kanban-column-header.done { 
        background: linear-gradient(135deg, #55efc4 0%, #00b894 100%); 
        color: white;
    }

    .kanban-column-header i {
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    .kanban-column-header span {
        white-space: nowrap;
        flex-shrink: 0;
    }

    /* Task Timer Badge */
    .task-timer-badge {
        display: inline-block;
        padding: 6px 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 8px;
    }

    .task-timer-badge.paused {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    /* Search and Filter Toolbar */
    .kanban-toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 20px;
        padding: 16px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 10px;
    }

    .search-box {
        flex: 1;
        min-width: 250px;
        position: relative;
    }

    .search-box input {
        width: 100%;
        padding: 10px 40px 10px 16px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
    }

    .search-box input:focus {
        outline: none;
        border-color: var(--jira-blue);
        box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.1);
    }

    .search-box i {
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--jira-gray-700);
    }

    .filter-group {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    /* Custom Dropdown Wrapper */
    .custom-dropdown-wrapper {
        position: relative;
        min-width: 200px;
    }

    .custom-dropdown-trigger {
        width: 100%;
        padding: 10px 40px 10px 16px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        text-align: left;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .custom-dropdown-trigger:hover {
        border-color: var(--jira-blue);
    }

    .custom-dropdown-trigger.active {
        border-color: var(--jira-blue);
        box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.1);
    }

    .custom-dropdown-trigger i {
        color: var(--jira-gray-700);
        transition: transform 0.3s;
    }

    .custom-dropdown-trigger.open i {
        transform: rotate(180deg);
    }

    .custom-dropdown-menu {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        background: white;
        border: 2px solid var(--jira-blue);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
        display: none;
    }

    .custom-dropdown-menu.show {
        display: block;
    }

    .custom-dropdown-search {
        position: sticky;
        top: 0;
        background: white;
        padding: 8px;
        border-bottom: 1px solid #e9ecef;
    }

    .custom-dropdown-search input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        font-size: 14px;
    }

    .custom-dropdown-search input:focus {
        outline: none;
        border-color: var(--jira-blue);
    }

    .custom-dropdown-options {
        padding: 4px 0;
    }

    .custom-dropdown-option {
        padding: 10px 16px;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 14px;
    }

    .custom-dropdown-option:hover {
        background: var(--jira-blue-light);
    }

    .custom-dropdown-option.selected {
        background: var(--jira-blue-light);
        font-weight: 500;
        color: var(--jira-blue);
    }

    .filter-active {
        border-color: var(--jira-blue) !important;
        background: var(--jira-blue-light) !important;
    }

    .clear-filters-btn {
        padding: 10px 20px;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .clear-filters-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
    }

    .fullscreen-btn {
        padding: 10px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-left: auto;
    }

    .fullscreen-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    /* Fullscreen Mode */
    .kanban-fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: white;
        z-index: 9999;
        overflow: auto;
        padding: 20px;
    }

    .kanban-fullscreen .kanban-toolbar {
        position: sticky;
        top: 0;
        z-index: 100;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .kanban-fullscreen .card-body > h5:first-child {
        font-size: 1.5rem;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--jira-gray-200);
    }

    .kanban-fullscreen .kanban-column-header {
        font-size: 1.1rem;
        min-height: 60px;
        height: 60px;
        padding: 18px 16px;
    }

    .kanban-fullscreen .task-card {
        margin-bottom: 20px;
        font-size: 0.95rem;
    }

    .exit-fullscreen-btn {
        padding: 10px 20px;
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-left: auto;
    }

    .exit-fullscreen-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(250, 112, 154, 0.3);
    }

    .hidden {
        display: none !important;
    }

    /* No tasks message styling */
    .no-tasks-msg {
        padding: 20px;
        text-align: center;
        font-style: italic;
    }

    /* Hide original select */
    .filter-select {
        display: none;
    }
</style>

<!-- Page Header -->
<div class="d-flex align-items-center mb-4" id="page-header">
    <h5 class="fw-bold mb-0 me-2">Project/Event</h5>
    <i class="fas fa-chevron-right text-muted"></i>
    <h5 class="fw-bold mb-0 ms-2 text-primary">
        {% if current_project %}
            {{ current_project.name }}
        {% else %}
            All Projects
        {% endif %}
    </h5>
</div>

<!-- Navigation Tabs -->
<div class="summary-nav" id="navigation-tabs">
    {% if request.user.role == 'hod' %}
        <a class="summary-nav-item {% if request.resolver_match.url_name == 'hod_dashboard' %}active{% endif %}"
            href="{% url 'accounts:hod_dashboard' %}?project={{ current_project.id }}">
            Summary
        </a>
    {% elif request.user.role == 'coordinator' %}
        <a class="summary-nav-item {% if request.resolver_match.url_name == 'coordinator_dashboard' %}active{% endif %}"
            href="{% url 'accounts:coordinator_dashboard' %}?project={{ current_project.id }}">
            Summary
        </a>
    {% else %}
    <a class="summary-nav-item {% if request.resolver_match.url_name == 'staff_dashboard' %}active{% endif %}" 
       href="{% url 'accounts:staff_dashboard' %}?project={{ current_project.id }}">
        Summary
    </a>
    {% endif %}
    <a class="summary-nav-item {% if active_tab == 'backlog' %}active{% endif %}" 
       href="{% url 'accounts:backlog_page' %}{% if current_project %}?project={{ current_project.id }}{% endif %}">
        Backlog
    </a>
    <a class="summary-nav-item {% if active_tab == 'board' %}active{% endif %}" 
       href="{% url 'accounts:board_page' %}{% if current_project %}?project={{ current_project.id }}{% endif %}">
        Board
    </a>
</div>

<!-- Content -->
<div class="summary-content" id="summary-content">
    <!-- Top Stats + Status Overview -->
    <div class="row g-4 mb-4 align-items-stretch" id="stats-section">
        <!-- Stats Cards -->
        <div class="col-lg-6 d-flex flex-column gap-2 h-100">
            <!-- First Row: Completed, Updated, In Review -->
            <div class="row g-2 mb-2">
                <div class="col-4">
                    <div class="card p-3 shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                        <i class="fas fa-clipboard-check fs-4 mb-1 text-success"></i>
                        <h5 class="card-title text-success mb-1">{{ completed_count }} Completed</h5>
                        <p class="card-text text-muted mb-0">in last 7 days</p>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card p-3 shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                        <i class="fas fa-sync fs-4 mb-1 text-primary"></i>
                        <h5 class="card-title text-primary mb-1">{{ updated_count }} Updated</h5>
                        <p class="card-text text-muted mb-0">in last 7 days</p>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card p-3 shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                        <i class="fas fa-eye fs-4 mb-1 text-warning"></i>
                        <h5 class="card-title text-warning mb-1">{{ in_review_count|default:0 }} In Review</h5>
                        <p class="card-text text-muted mb-0">awaiting review</p>
                    </div>
                </div>
            </div>

            <!-- Second Row: In Progress, Created, Due Soon, Done -->
            <div class="row g-2">
                <div class="col-3">
                    <div class="card p-3 shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                        <i class="fas fa-spinner fa-spin text-info"></i>
                        <h5 class="card-title text-info mb-1">{{ in_progress_count|default:0 }} In Progress</h5>
                        <p class="card-text text-muted mb-0">currently ongoing</p>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card p-3 shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                        <i class="fas fa-plus-circle fs-4 mb-1 text-warning"></i>
                        <h5 class="card-title text-warning mb-1">{{ created_count|default:0 }} Created</h5>
                        <p class="card-text text-muted mb-0">in last 7 days</p>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card p-3 shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                        <i class="fas fa-calendar-times fs-4 mb-1 text-danger"></i>
                        <h5 class="card-title text-danger mb-1">{{ due_soon_count|default:0 }} Due Soon</h5>
                        <p class="card-text text-muted mb-0">in next 7 days</p>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card p-3 shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                        <i class="fas fa-check-circle fs-4 mb-1 text-success"></i>
                        <h5 class="card-title text-success mb-1">{{ done_count|default:0 }} Done</h5>
                        <p class="card-text text-muted mb-0">completed tasks</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Chart -->
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                    <h5 class="card-title mb-1"><i class="fas fa-tachometer-alt me-1"></i>Status Overview</h5>
                    <!-- Chart Canvas -->
                    <canvas id="statusChart" style="max-width:200px; max-height:120px;"></canvas>
                    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                    <script>
                        var ctx = document.getElementById('statusChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: ['To Do', 'In Progress', 'In Review', 'Done'],
                                datasets: [{
                                    data: [
                                        {{ todo_count|default:0 }},
                                        {{ in_progress_count|default:0 }},
                                        {{ in_review_count|default:0 }},
                                        {{ done_count|default:0 }}
                                    ],
                                    backgroundColor: [
                                        '#6c757d',
                                        '#0d6efd',
                                        '#ffc107',
                                        '#198754'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { display: false }
                                },
                                maintainAspectRatio: false
                            }
                        });
                    </script>

                    <!-- Status Badges -->
                    <div class="mt-3 text-center d-flex justify-content-center gap-3 flex-wrap">
                        <span class="badge bg-secondary">Yet to Start: {{ todo_count|default:0 }}</span>
                        <span class="badge bg-primary">In Progress: {{ in_progress_count|default:0 }}</span>
                        <span class="badge bg-warning text-dark">In Review: {{ in_review_count|default:0 }}</span>
                        <span class="badge bg-success">Done: {{ done_count|default:0 }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kanban Tasks -->
    <div class="row g-4">
        <div class="col-12">
            <div class="card shadow-sm" id="kanban-board">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-tasks me-1"></i>
                        {% if request.user.role == 'staff' %}All Tasks{% else %}Tasks{% endif %}
                    </h5>
                    {% if request.user.role == 'staff' %}
                    <p class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>
                        Tasks assigned to you (editable) and tasks you've created for others (view-only)
                    </p>
                    {% endif %}

                    <!-- Hidden Select Elements for Data -->
                    <select class="filter-select" id="filter-team" style="display: none;">
                        <option value="">All Teams</option>
                        {% for team in teams %}
                            <option value="{{ team.id }}">{{ team.name }}</option>
                        {% endfor %}
                    </select>

                    <select class="filter-select" id="filter-user" style="display: none;">
                        <option value="">All Users</option>
                        {% for user in staff_and_students %}
                            <option value="{{ user.id }}"
                                    data-team-ids="{% for team in user.teams.all %}{{ team.id }}{% if not forloop.last %},{% endif %}{% endfor %}"
                                    data-email="{{ user.email|lower }}">
                                {{ user.email }}
                            </option>
                        {% endfor %}
                    </select>


                    <!-- Search and Filter Toolbar -->
                    <div class="kanban-toolbar">
                        <!-- Search Box -->
                        <div class="search-box">
                            <input type="text" id="task-search" placeholder="Search tasks by title or description...">
                            <i class="fas fa-search"></i>
                        </div>

                        <!-- Custom Team Filter with Search -->
                        <div class="filter-group">
                            <div class="custom-dropdown-wrapper" id="team-dropdown-wrapper">
                                <div class="custom-dropdown-trigger" id="team-dropdown-trigger">
                                    <span id="team-selected-text">All Teams</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="custom-dropdown-menu" id="team-dropdown-menu">
                                    <div class="custom-dropdown-search">
                                        <input type="text" id="team-search-input" placeholder="Search teams...">
                                    </div>
                                    <div class="custom-dropdown-options" id="team-options"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Custom User Filter with Search -->
                        <div class="filter-group">
                            <div class="custom-dropdown-wrapper" id="user-dropdown-wrapper">
                                <div class="custom-dropdown-trigger" id="user-dropdown-trigger">
                                    <span id="user-selected-text">All Users</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="custom-dropdown-menu" id="user-dropdown-menu">
                                    <div class="custom-dropdown-search">
                                        <input type="text" id="user-search-input" placeholder="Search users...">
                                    </div>
                                    <div class="custom-dropdown-options" id="user-options"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Clear Filters -->
                        <button class="clear-filters-btn" id="clear-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>

                        <!-- Fullscreen Toggle -->
                        <button class="fullscreen-btn" id="fullscreen-toggle">
                            <i class="fas fa-expand"></i>
                            Fullscreen
                        </button>
                    </div>

                    <div class="row" id="kanban-columns">
                    <hr>
                        <!-- To Do Column -->
                        <div class="col-md-4">
                            <div class="kanban-column-header todo">
                                <i class="fas fa-list"></i>
                                <span>Yet to Start</span>
                            </div>
                            <div class="kanban-column-content" data-status="to_do">
                            {% for task in kanban_tasks.to_do %}
                                <div class="card mb-3 p-3 task-card todo-card" 
                                     data-task-title="{{ task.title|lower }}" 
                                     data-task-description="{{ task.description|lower }}"
                                     data-task-team-ids="{{ task.team.id|default:'' }}"
                                     data-task-user="{{ task.assigned_to.id|default:'' }}">
                                    {% if request.user.role == 'staff' %}
                                    <div class="mb-2">
                                        {% if task.assigned_to == request.user %}
                                            <span class="badge bg-primary">My Task</span>
                                        {% else %}
                                            <span class="badge bg-info">Created by Me</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    <h6 class="fw-bold mb-2">{{ task.title }}</h6>
                                    <p class="text-muted small mb-2">{{ task.description }}</p>
                                    <p class="task-info mb-0">
                                        <strong>Assigned to:</strong> 
                                        {% if task.team %}{{ task.team.name }}{% endif %}
                                        {% if task.assigned_to %} - {{ task.assigned_to.email }}{% endif %}
                                        {% if not task.team and not task.assigned_to %}Unassigned{% endif %}
                                    </p>

                                    <div class="text-center my-2">
                                        {% if request.user.role == 'staff' and task.assigned_to != request.user %}
                                            <div class="task-timer-badge">
                                                <i class="fas fa-clock me-1"></i>
                                                <span>
                                                    {% if task.total_time %}
                                                        {{ task.total_time|format_duration }}
                                                    {% else %}
                                                        In Progress
                                                    {% endif %}
                                                </span>
                                            </div>
                                        {% else %}
                                            <div class="task-timer-badge {% if task.is_paused %}paused{% endif %}" id="task-timer-{{ task.id }}">
                                                <i class="fas fa-clock me-1"></i>
                                                <span id="task-time-{{ task.id }}">0h 0m 0s</span>
                                            </div>
                                        {% endif %}
                                    </div>

                                    {% if task.subtasks.all %}
                                        <div class="mt-3 mb-2">
                                            <small class="text-muted fw-bold">Subtasks:</small>
                                            {% for subtask in task.subtasks.all %}
                                                <div class="subtask d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded"
                                                    {% if request.user.role != 'staff' or task.assigned_to == request.user %}
                                                    id="subtask-{{ subtask.id }}"
                                                    data-subtask-id="{{ subtask.id }}"
                                                    data-task-id="{{ task.id }}"
                                                    data-time-spent="{{ subtask.time_spent_seconds|default:0 }}"
                                                    {% endif %}>
                                                    
                                                    <div>
                                                        <strong class="small">{{ subtask.title }}</strong><br>
                                                        <span class="badge bg-secondary" 
                                                              {% if request.user.role != 'staff' or task.assigned_to == request.user %}
                                                              id="timer-{{ subtask.id }}"
                                                              {% endif %}>
                                                            {{ subtask.time_spent_seconds|format_duration }}
                                                        </span>
                                                    </div>
                                                    
                                                    {% if request.user.role == 'staff' and task.assigned_to != request.user %}
                                                    {% else %}
                                                        <div>
                                                            {% if not is_read_only %}
                                                                <button class="btn btn-sm btn-success" id="start-{{ subtask.id }}" 
                                                                    onclick="startSubtaskTimer({{ subtask.id }}, {{ subtask.time_spent_seconds|default:0 }})">
                                                                    <i class="fas fa-play"></i>
                                                                </button>
                                                                <button class="btn btn-sm btn-danger" id="stop-{{ subtask.id }}" 
                                                                    onclick="stopSubtaskTimer({{ subtask.id }})" disabled>
                                                                    <i class="fas fa-stop"></i>
                                                                </button>
                                                            {% else %}
                                                                <button class="btn btn-sm btn-success" disabled title="Read Only"><i class="fas fa-play"></i></button>
                                                                <button class="btn btn-sm btn-danger" disabled title="Read Only"><i class="fas fa-stop"></i></button>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}

                                    <div class="task-actions">
                                        {% if request.user.role == 'staff' %}
                                            {% if task.assigned_to == request.user %}
                                                {% if not is_read_only %}
                                                    <button type="button" class="task-action-btn btn-pause-task" id="pause-btn-{{ task.id }}" onclick="pauseTask({{ task.id }})" {% if task.is_paused %}style="display: none;"{% endif %}>
                                                        <i class="fas fa-pause"></i>
                                                        <span>Pause Task</span>
                                                    </button>
                                                    <button type="button" class="task-action-btn btn-resume-task" id="resume-btn-{{ task.id }}" onclick="resumeTask({{ task.id }})" {% if not task.is_paused %}style="display: none;"{% endif %}>
                                                        <i class="fas fa-play"></i>
                                                        <span>Resume Task</span>
                                                    </button>
                                                    <form method="POST" action="{% url 'accounts:update_task_status' %}" onsubmit="return beforeComplete({{ task.id }})">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="task_id" value="{{ task.id }}">
                                                        <input type="hidden" name="new_status" value="done">
                                                        <input type="hidden" name="total_time" id="total-time-{{ task.id }}" value="0">
                                                        <button type="submit" class="task-action-btn btn-move-done">
                                                            <i class="fas fa-check"></i>
                                                            <span>Mark Complete</span>
                                                        </button>
                                                    </form>
                                                {% else %}
                                                    <button type="button" class="task-action-btn btn-pause-task" disabled title="Read only">
                                                        <i class="fas fa-pause"></i>
                                                        <span>Read only</span>
                                                    </button>
                                                {% endif %}
                                            {% else %}
                                                <div class="alert alert-info small mb-0 text-center py-2">
                                                    <i class="fas fa-eye me-1"></i>View Only
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            {% if not is_read_only %}
                                                <button type="button" class="task-action-btn btn-pause-task" id="pause-btn-{{ task.id }}" onclick="pauseTask({{ task.id }})" {% if task.is_paused %}style="display: none;"{% endif %}>
                                                    <i class="fas fa-pause"></i>
                                                    <span>Pause Task</span>
                                                </button>
                                                <button type="button" class="task-action-btn btn-resume-task" id="resume-btn-{{ task.id }}" onclick="resumeTask({{ task.id }})" {% if not task.is_paused %}style="display: none;"{% endif %}>
                                                    <i class="fas fa-play"></i>
                                                    <span>Resume Task</span>
                                                </button>
                                                <form method="POST" action="{% url 'accounts:update_task_status' %}" onsubmit="return beforeComplete({{ task.id }})">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="task_id" value="{{ task.id }}">
                                                    <input type="hidden" name="new_status" value="done">
                                                    <input type="hidden" name="total_time" id="total-time-{{ task.id }}" value="0">
                                                    <button type="submit" class="task-action-btn btn-move-done">
                                                        <i class="fas fa-check"></i>
                                                        <span>Mark Complete</span>
                                                    </button>
                                                </form>
                                            {% else %}
                                                <button type="button" class="task-action-btn btn-pause-task" disabled title="Read only" {% if task.is_paused %}style="display:none;"{% endif %}>
                                                    <i class="fas fa-pause"></i>
                                                    <span>Read only</span>
                                                </button>
                                                <button type="button" class="task-action-btn btn-resume-task" disabled title="Read only" {% if not task.is_paused %}style="display:none;"{% endif %}>
                                                    <i class="fas fa-play"></i>
                                                    <span>Read only</span>
                                                </button>
                                                <button class="task-action-btn btn-move-done" disabled title="Read only">
                                                    <i class="fas fa-check"></i>
                                                    <span>Read only</span>
                                                </button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            {% empty %}
                                <p class="text-muted text-center no-tasks-msg">No tasks</p>
                            {% endfor %}
                            </div>
                        </div>
                        
                        <!-- In Progress Column -->
                        <div class="col-md-4">
                            <div class="kanban-column-header progress">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>In Progress</span>
                            </div>
                            <div class="kanban-column-content" data-status="in_progress">
                            {% for task in kanban_tasks.in_progress %}
                                <div class="card mb-3 p-3 task-card progress-card"
                                    data-task-title="{{ task.title|lower }}"
                                    data-task-description="{{ task.description|lower }}"
                                    data-task-team-ids="{{ task.team.id|default:'' }}"
                                    data-task-user="{{ task.assigned_to.id|default:'' }}"
                                    id="task-card-{{ task.id }}"
                                    data-task-id="{{ task.id }}"
                                    data-start-time="{{ task.start_time|date:'c' }}"
                                    data-accumulated-time="{{ task.accumulated_time|default:0 }}"
                                    data-is-paused="{{ task.is_paused|default:'false' }}"
                                    data-pause-time="{{ task.pause_time|date:'c'|default:'' }}">
                                    
                                    {% if request.user.role == 'staff' %}
                                    <div class="mb-2">
                                        {% if task.assigned_to == request.user %}
                                            <span class="badge bg-primary">My Task</span>
                                        {% else %}
                                            <span class="badge bg-info">Created by Me</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    <h6 class="fw-bold mb-2">{{ task.title }}</h6>
                                    <p class="text-muted small mb-2">{{ task.description }}</p>
                                    <p class="task-info mb-0">
                                        <strong>Assigned to:</strong> 
                                        {% if task.team %}{{ task.team.name }}{% endif %}
                                        {% if task.assigned_to %} - {{ task.assigned_to.email }}{% endif %}
                                        {% if not task.team and not task.assigned_to %}Unassigned{% endif %}
                                    </p>

                                    <div class="text-center my-2">
                                        {% if request.user.role == 'staff' and task.assigned_to != request.user %}
                                            <div class="task-timer-badge">
                                                <i class="fas fa-clock me-1"></i>
                                                <span>
                                                    {% if task.total_time %}
                                                        {{ task.total_time|format_duration }}
                                                    {% else %}
                                                        In Progress
                                                    {% endif %}
                                                </span>
                                            </div>
                                        {% else %}
                                            <div class="task-timer-badge {% if task.is_paused %}paused{% endif %}" id="task-timer-{{ task.id }}">
                                                <i class="fas fa-clock me-1"></i>
                                                <span id="task-time-{{ task.id }}">0h 0m 0s</span>
                                            </div>
                                        {% endif %}
                                    </div>

                                    {% if task.subtasks.all %}
                                        <div class="mt-3 mb-2">
                                            <small class="text-muted fw-bold">Subtasks:</small>
                                            {% for subtask in task.subtasks.all %}
                                                <div class="subtask d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded"
                                                    {% if request.user.role != 'staff' or task.assigned_to == request.user %}
                                                    id="subtask-{{ subtask.id }}"
                                                    data-subtask-id="{{ subtask.id }}"
                                                    data-task-id="{{ task.id }}"
                                                    data-time-spent="{{ subtask.time_spent_seconds|default:0 }}"
                                                    {% endif %}>
                                                    
                                                    <div>
                                                        <strong class="small">{{ subtask.title }}</strong><br>
                                                        <span class="badge bg-secondary" 
                                                              {% if request.user.role != 'staff' or task.assigned_to == request.user %}
                                                              id="timer-{{ subtask.id }}"
                                                              {% endif %}>
                                                            {{ subtask.time_spent_seconds|format_duration }}
                                                        </span>
                                                    </div>
                                                    
                                                    {% if request.user.role == 'staff' and task.assigned_to != request.user %}
                                                    {% else %}
                                                        <div>
                                                            {% if not is_read_only %}
                                                                <button class="btn btn-sm btn-success" id="start-{{ subtask.id }}" 
                                                                    onclick="startSubtaskTimer({{ subtask.id }}, {{ subtask.time_spent_seconds|default:0 }})">
                                                                    <i class="fas fa-play"></i>
                                                                </button>
                                                                <button class="btn btn-sm btn-danger" id="stop-{{ subtask.id }}" 
                                                                    onclick="stopSubtaskTimer({{ subtask.id }})" disabled>
                                                                    <i class="fas fa-stop"></i>
                                                                </button>
                                                            {% else %}
                                                                <button class="btn btn-sm btn-success" disabled title="Read Only"><i class="fas fa-play"></i></button>
                                                                <button class="btn btn-sm btn-danger" disabled title="Read Only"><i class="fas fa-stop"></i></button>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}

                                    <div class="task-actions">
                                        {% if request.user.role == 'staff' %}
                                            {% if task.assigned_to == request.user %}
                                                {% if not is_read_only %}
                                                    <button type="button" class="task-action-btn btn-pause-task" id="pause-btn-{{ task.id }}" onclick="pauseTask({{ task.id }})" {% if task.is_paused %}style="display: none;"{% endif %}>
                                                        <i class="fas fa-pause"></i>
                                                        <span>Pause Task</span>
                                                    </button>
                                                    <button type="button" class="task-action-btn btn-resume-task" id="resume-btn-{{ task.id }}" onclick="resumeTask({{ task.id }})" {% if not task.is_paused %}style="display: none;"{% endif %}>
                                                        <i class="fas fa-play"></i>
                                                        <span>Resume Task</span>
                                                    </button>
                                                    <form method="POST" action="{% url 'accounts:update_task_status' %}" onsubmit="return beforeComplete({{ task.id }})">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="task_id" value="{{ task.id }}">
                                                        <input type="hidden" name="new_status" value="done">
                                                        <input type="hidden" name="total_time" id="total-time-{{ task.id }}" value="0">
                                                        <button type="submit" class="task-action-btn btn-move-done">
                                                            <i class="fas fa-check"></i>
                                                            <span>Mark Complete</span>
                                                        </button>
                                                    </form>
                                                {% else %}
                                                    <button type="button" class="task-action-btn btn-pause-task" disabled title="Read only">
                                                        <i class="fas fa-pause"></i>
                                                        <span>Read only</span>
                                                    </button>
                                                {% endif %}
                                            {% else %}
                                                <div class="alert alert-info small mb-0 text-center py-2">
                                                    <i class="fas fa-eye me-1"></i>View Only
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            {% if not is_read_only %}
                                                <button type="button" class="task-action-btn btn-pause-task" id="pause-btn-{{ task.id }}" onclick="pauseTask({{ task.id }})" {% if task.is_paused %}style="display: none;"{% endif %}>
                                                    <i class="fas fa-pause"></i>
                                                    <span>Pause Task</span>
                                                </button>
                                                <button type="button" class="task-action-btn btn-resume-task" id="resume-btn-{{ task.id }}" onclick="resumeTask({{ task.id }})" {% if not task.is_paused %}style="display: none;"{% endif %}>
                                                    <i class="fas fa-play"></i>
                                                    <span>Resume Task</span>
                                                </button>
                                                <form method="POST" action="{% url 'accounts:update_task_status' %}" onsubmit="return beforeComplete({{ task.id }})">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="task_id" value="{{ task.id }}">
                                                    <input type="hidden" name="new_status" value="done">
                                                    <input type="hidden" name="total_time" id="total-time-{{ task.id }}" value="0">
                                                    <button type="submit" class="task-action-btn btn-move-done">
                                                        <i class="fas fa-check"></i>
                                                        <span>Mark Complete</span>
                                                    </button>
                                                </form>
                                            {% else %}
                                                <button type="button" class="task-action-btn btn-pause-task" disabled title="Read only" {% if task.is_paused %}style="display:none;"{% endif %}>
                                                    <i class="fas fa-pause"></i>
                                                    <span>Read only</span>
                                                </button>
                                                <button type="button" class="task-action-btn btn-resume-task" disabled title="Read only" {% if not task.is_paused %}style="display:none;"{% endif %}>
                                                    <i class="fas fa-play"></i>
                                                    <span>Read only</span>
                                                </button>
                                                <button class="task-action-btn btn-move-done" disabled title="Read only">
                                                    <i class="fas fa-check"></i>
                                                    <span>Read only</span>
                                                </button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            {% empty %}
                                <p class="text-muted text-center no-tasks-msg">No tasks</p>
                            {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Done Column -->
                        <div class="col-md-4">
                            <div class="kanban-column-header done">
                                <i class="fas fa-check-circle"></i>
                                <span>Done</span>
                            </div>
                            <div class="kanban-column-content" data-status="done">
                            {% for task in kanban_tasks.done %}
                                <div class="card mb-3 p-3 task-card done-card"
                                    data-task-title="{{ task.title|lower }}"
                                    data-task-description="{{ task.description|lower }}"
                                    data-task-team-ids="{{ task.team.id|default:'' }}"
                                    data-task-user="{{ task.assigned_to.id|default:'' }}">
                                    {% if request.user.role == 'staff' %}
                                    <div class="mb-2">
                                        {% if task.assigned_to == request.user %}
                                            <span class="badge bg-primary">My Task</span>
                                        {% else %}
                                            <span class="badge bg-info">Created by Me</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    <h6 class="fw-bold mb-2">{{ task.title }}</h6>
                                    <p class="text-muted small mb-2">{{ task.description }}</p>
                                    <p class="task-info mb-1">
                                        <strong>Assigned to:</strong> 
                                        {% if task.team %}{{ task.team.name }}{% endif %}
                                        {% if task.assigned_to %} - {{ task.assigned_to.email }}{% endif %}
                                        {% if not task.team and not task.assigned_to %}Unassigned{% endif %}
                                    </p>
                                    <p class="task-info mb-0">
                                        <strong>Total Time:</strong> 
                                        <span class="badge bg-success">{{ task.total_time|format_duration }}</span>
                                    </p>

                                    <div class="task-actions">
                                        {% if request.user.role == 'staff' %}
                                            {% if task.assigned_to == request.user %}
                                                {% if not is_read_only %}
                                                <form method="POST" action="{% url 'accounts:update_task_status' %}">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="task_id" value="{{ task.id }}">
                                                    <input type="hidden" name="new_status" value="in_progress">
                                                    <button type="submit" class="task-action-btn btn-back-progress">
                                                        <i class="fas fa-arrow-left"></i>
                                                        <span>Reopen Task</span>
                                                    </button>
                                                </form>
                                                {% else %}
                                                <button class="task-action-btn btn-back-progress" disabled title="Read only">
                                                    <i class="fas fa-arrow-left"></i>
                                                    <span>Read only</span>
                                                </button>
                                                {% endif %}
                                            {% else %}
                                                <div class="alert alert-success small mb-0 text-center py-2">
                                                    <i class="fas fa-check-circle me-1"></i>Completed
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            {% if not is_read_only %}
                                            <form method="POST" action="{% url 'accounts:update_task_status' %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="task_id" value="{{ task.id }}">
                                                <input type="hidden" name="new_status" value="in_progress">
                                                <button type="submit" class="task-action-btn btn-back-progress">
                                                    <i class="fas fa-arrow-left"></i>
                                                    <span>Reopen Task</span>
                                                </button>
                                            </form>
                                            {% else %}
                                            <button class="task-action-btn btn-back-progress" disabled title="Read only">
                                                <i class="fas fa-arrow-left"></i>
                                                <span>Read only</span>
                                            </button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            {% empty %}
                                <p class="text-muted text-center no-tasks-msg">No tasks</p>
                            {% endfor %}
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

{% if is_read_only %}
<script>
    function startTask(){ return; }
    function pauseTask(){ return; }
    function resumeTask(){ return; }
    function beforeComplete(){ return false; }
    function startSubtaskTimer(){ return; }
    function stopSubtaskTimer(){ return; }
</script>
{% endif %}

<script>
// Store task timers and their states
const taskTimers = {};
const subtaskTimers = {};

// Custom Dropdown Class
class CustomDropdown {
    constructor(wrapperId, selectId, placeholderText) {
        this.wrapper = document.getElementById(wrapperId);
        this.trigger = this.wrapper.querySelector('.custom-dropdown-trigger');
        this.menu = this.wrapper.querySelector('.custom-dropdown-menu');
        
        if (wrapperId === "team-dropdown-wrapper") {
            this.selectedText = document.getElementById("team-selected-text");
        } else if (wrapperId === "user-dropdown-wrapper") {
            this.selectedText = document.getElementById("user-selected-text");
        } else {
            this.selectedText = null;
        }

        this.searchInput = this.wrapper.querySelector('.custom-dropdown-search input');
        this.optionsContainer = this.wrapper.querySelector('.custom-dropdown-options');
        this.select = document.getElementById(selectId);
        this.placeholderText = placeholderText;
        this.selectedValue = '';
        
        this.init();
    }
    
    init() {
        this.populateOptions();
        
        this.trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggle();
        });
        
        this.searchInput.addEventListener('input', () => {
            this.filterOptions(this.searchInput.value);
        });
        
        document.addEventListener('click', (e) => {
            if (!this.wrapper.contains(e.target)) {
                this.close();
            }
        });
        
        this.menu.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    }
    
    populateOptions(filterTeamId = null) {
        console.log('=== POPULATE OPTIONS CALLED ===');
        console.log('Filter Team ID:', filterTeamId);
        console.log('Filter Team ID Type:', typeof filterTeamId);
        
        this.optionsContainer.innerHTML = '';
        const options = Array.from(this.select.options);
        
        console.log('Total options in select:', options.length);
        
        let addedCount = 0;
        
        options.forEach((option, index) => {
            if (index === 0) {
                // "All" option - always show
                const optionEl = document.createElement('div');
                optionEl.className = 'custom-dropdown-option';
                if (this.selectedValue === '') optionEl.classList.add('selected');
                optionEl.textContent = option.textContent;
                optionEl.dataset.value = '';
                optionEl.addEventListener('click', () => this.selectOption('', option.textContent));
                this.optionsContainer.appendChild(optionEl);
                addedCount++;
                console.log('Added "All Users" option');
            } else {
                const userEmail = option.textContent;
                const userId = option.value;
                const teamIdsAttr = option.getAttribute('data-team-ids');
                
                console.log('---');
                console.log('Processing User:', userEmail);
                console.log('User ID:', userId);
                console.log('Team IDs Attribute:', teamIdsAttr);
                
                // Filter users by team if filterTeamId is provided
                if (filterTeamId) {
                    if (!teamIdsAttr || teamIdsAttr.trim() === '') {
                        console.log(' Skipping - no teams for this user');
                        return; // Skip users with no teams
                    }
                    
                    const teamIds = teamIdsAttr.split(',').map(id => id.trim()).filter(x => x);
                    console.log('Parsed Team IDs:', teamIds);
                    console.log('Team IDs Types:', teamIds.map(id => typeof id));
                    console.log('Looking for Team ID:', filterTeamId, '(Type:', typeof filterTeamId + ')');
                    
                    const matchFound = teamIds.includes(String(filterTeamId));
                    console.log('Match Found:', matchFound);
                    
                    // Only show users who belong to the selected team
                    if (!matchFound) {
                        console.log(' Skipping - user not in selected team');
                        return; // Skip this user
                    }
                    
                    console.log(' User belongs to selected team - adding to dropdown');
                }
                
                const optionEl = document.createElement('div');
                optionEl.className = 'custom-dropdown-option';
                if (String(this.selectedValue) === String(option.value)) {
                    optionEl.classList.add('selected');
                }

                optionEl.textContent = option.textContent;
                optionEl.dataset.value = option.value;
                
                // Copy data attributes for user options
                const emailAttr = option.getAttribute('data-email');
                if (teamIdsAttr) optionEl.dataset.teamIds = teamIdsAttr;
                if (emailAttr) optionEl.dataset.email = emailAttr;
                
                optionEl.addEventListener('click', () => this.selectOption(option.value, option.textContent));
                this.optionsContainer.appendChild(optionEl);
                addedCount++;
            }
        });
        
        console.log('=== POPULATE OPTIONS COMPLETE ===');
        console.log('Total options added to dropdown:', addedCount);
        console.log('Options in container:', this.optionsContainer.children.length);
    }
    
    filterOptions(searchTerm) {
        const term = searchTerm.toLowerCase();
        const options = this.optionsContainer.querySelectorAll('.custom-dropdown-option');
        
        options.forEach(option => {
            const text = option.textContent.toLowerCase();
            if (text.includes(term)) {
                option.style.display = '';
            } else {
                option.style.display = 'none';
            }
        });
    }
    
    selectOption(value, text) {
        this.selectedValue = value;
        this.selectedText.textContent = text;
        this.select.value = value || "";

        this.optionsContainer.querySelectorAll('.custom-dropdown-option').forEach(opt => {
            opt.classList.remove('selected');
            if (opt.dataset.value === value) {
                opt.classList.add('selected');
            }
        });
        
        if (value) {
            this.trigger.classList.add('filter-active');
        } else {
            this.trigger.classList.remove('filter-active');
        }
        
        setTimeout(() => {
            this.select.dispatchEvent(new Event('change', { bubbles: true }));
        }, 10);
        
        this.close();
    }
    
    toggle() {
        if (this.menu.classList.contains('show')) {
            this.close();
        } else {
            this.open();
        }
    }
    
    open() {
        document.querySelectorAll('.custom-dropdown-menu.show').forEach(menu => {
            menu.classList.remove('show');
        });
        document.querySelectorAll('.custom-dropdown-trigger.open').forEach(trigger => {
            trigger.classList.remove('open');
        });
        
        this.menu.classList.add('show');
        this.trigger.classList.add('open');
        this.searchInput.value = '';
        this.filterOptions('');
        this.searchInput.focus();
    }
    
    close() {
        this.menu.classList.remove('show');
        this.trigger.classList.remove('open');
    }
    
    reset() {
        this.selectedValue = '';
        this.selectedText.textContent = this.placeholderText;
        this.select.value = "";
        this.searchInput.value = '';
        this.trigger.classList.remove('filter-active');
        this.filterOptions('');
    }
}




// Initialize custom dropdowns
let teamDropdown, userDropdown;

// Start a task
function startTask(taskId) {
    fetch("{% url 'accounts:start_task_timer' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `task_id=${taskId}`
    })
    .then(r => r.json())
    .then(data => { if (data.success) location.reload(); });
}

// Pause task timer
function pauseTask(taskId) {
    if (taskTimers[taskId]) clearInterval(taskTimers[taskId].intervalId);

    const card = document.querySelector(`[data-task-id="${taskId}"]`);
    const totalTime = calculateCurrentTime(card);

    fetch("{% url 'accounts:pause_task_timer' %}", {
        method: 'POST',
        headers:{
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body:`task_id=${taskId}&accumulated_time=${totalTime}`
    }).then(r => r.json()).then(data=>{
        if(data.success){
            document.getElementById(`pause-btn-${taskId}`).style.display='none';
            document.getElementById(`resume-btn-${taskId}`).style.display='block';
            const badge=document.getElementById(`task-timer-${taskId}`);
            badge.classList.add('paused');
            card.dataset.isPaused='true';
            card.dataset.accumulatedTime=totalTime;
            card.dataset.startTime='';
        }
    });
}

// Resume task timer
function resumeTask(taskId){
    fetch("{% url 'accounts:resume_task_timer' %}",{
        method:'POST',
        headers:{
            'Content-Type':'application/x-www-form-urlencoded',
            'X-CSRFToken':getCookie('csrftoken')
        },
        body:`task_id=${taskId}`
    }).then(r=>r.json()).then(data=>{
        if(data.success){
            document.getElementById(`pause-btn-${taskId}`).style.display='block';
            document.getElementById(`resume-btn-${taskId}`).style.display='none';

            const badge=document.getElementById(`task-timer-${taskId}`);
            badge.classList.remove('paused');

            const card=document.querySelector(`[data-task-id="${taskId}"]`);
            card.dataset.isPaused='false';
            card.dataset.startTime=data.start_time;

            startTimerInterval(taskId);
        }
    });
}

function calculateCurrentTime(card){
    const startTime=card.dataset.startTime;
    const accumulatedTime=parseInt(card.dataset.accumulatedTime)||0;
    const isPaused=card.dataset.isPaused==='true';

    if(isPaused || !startTime) return accumulatedTime;

    const start=new Date(startTime);
    const now=new Date();
    return accumulatedTime + Math.floor((now-start)/1000);
}

function updateTaskTimer(taskId){
    const card=document.querySelector(`[data-task-id="${taskId}"]`);
    if(!card) return;

    const total=calculateCurrentTime(card);
    const timeElement = document.getElementById(`task-time-${taskId}`);
    if(timeElement) {
        timeElement.innerText = formatDuration(total);
    }
}

function startTimerInterval(taskId){
    if(taskTimers[taskId]) clearInterval(taskTimers[taskId].intervalId);
    taskTimers[taskId]={ intervalId:setInterval(()=>updateTaskTimer(taskId),1000) };
}

window.addEventListener('load', ()=>{
    // Initialize custom dropdowns
    teamDropdown = new CustomDropdown('team-dropdown-wrapper', 'filter-team', 'All Teams');
    userDropdown = new CustomDropdown('user-dropdown-wrapper', 'filter-user', 'All Users');

    document.querySelectorAll('.progress-card').forEach(card=>{
        const taskId = card.dataset.taskId;
        if(!taskId) return;

        updateTaskTimer(taskId);
        if(card.dataset.isPaused!=='true') startTimerInterval(taskId);
    });

    // Initialize search and filter functionality
    initializeSearchAndFilter();
    initializeFullscreen();
});

function beforeComplete(taskId){
    const card=document.querySelector(`[data-task-id="${taskId}"]`);
    const total=calculateCurrentTime(card);
    document.getElementById(`total-time-${taskId}`).value=total;
    return true;
}

function startSubtaskTimer(subtaskId, seconds){
    const timerEl=document.getElementById(`timer-${subtaskId}`);
    if(!timerEl) return;
    
    seconds=parseInt(seconds);
    subtaskTimers[subtaskId]=setInterval(()=>{
        seconds++;
        timerEl.innerText=formatDuration(seconds);
    },1000);
}

function stopSubtaskTimer(subtaskId){
    clearInterval(subtaskTimers[subtaskId]);
    const timerEl = document.getElementById(`timer-${subtaskId}`);
    if(!timerEl) return;
    
    const timeStr=timerEl.innerText;
    const seconds=parseDurationToSeconds(timeStr);

    fetch("{% url 'accounts:update_subtask_time' %}",{
        method:'POST',
        headers:{
            'Content-Type':'application/x-www-form-urlencoded',
            'X-CSRFToken':getCookie('csrftoken')
        },
        body:`subtask_id=${subtaskId}&time_spent=${seconds}`
    });
}
function formatDuration(totalSeconds) {
    const days = Math.floor(totalSeconds / 86400); // 24 * 3600
    const hours = Math.floor((totalSeconds % 86400) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    // If more than or equal to 24 hours  show days also
    if (days > 0) {
        return `${days}d ${hours}h ${minutes}m ${seconds}s`;
    }

    // If less than 24 hours, show normal format
    if (hours > 0) {
        return `${hours}h ${minutes}m ${seconds}s`;
    }

    if (minutes > 0) {
        return `${minutes}m ${seconds}s`;
    }

    return `${seconds}s`;
}



function parseDurationToSeconds(str){
    let t=0;
    const h=str.match(/(\d+)h/);
    const m=str.match(/(\d+)m/);
    const s=str.match(/(\d+)s/);
    if(h) t+=parseInt(h[1])*3600;
    if(m) t+=parseInt(m[1])*60;
    if(s) t+=parseInt(s[1]);
    return t;
}

function getCookie(name){
    let cookieValue=null;
    document.cookie.split(';').forEach(cookie=>{
        cookie=cookie.trim();
        if(cookie.startsWith(name+'=')){
            cookieValue = decodeURIComponent(cookie.substring(name.length+1));
        }
    });
    return cookieValue;
}

// Search and Filter Functionality
function initializeSearchAndFilter() {
    const searchInput = document.getElementById('task-search');
    const teamFilter = document.getElementById('filter-team');
    const userFilter = document.getElementById('filter-user');
    const clearBtn = document.getElementById('clear-filters');

    // Search functionality
    searchInput.addEventListener('input', filterTasks);

    // Team filter change - FIXED
    teamFilter.addEventListener('change', function () {
        const selectedTeamId = this.value;

        // Clear the user filter selection
        userFilter.value = '';
        
        if (selectedTeamId) {
            // Populate only users in that team
            userDropdown.populateOptions(selectedTeamId);
        } else {
            // No team selected  show all users
            userDropdown.populateOptions(null);
        }

        // Reset the user dropdown display
        userDropdown.selectedValue = '';
        userDropdown.selectedText.textContent = 'All Users';
        userDropdown.trigger.classList.remove('filter-active');

        filterTasks();
    });

    // User filter change
    userFilter.addEventListener('change', function() {
        filterTasks();
    });

    // Clear filters
    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        teamDropdown.reset();
        userDropdown.populateOptions(null);
        userDropdown.reset();
        
        filterTasks();
    });
}

function filterTasks() {
    const searchTerm = document.getElementById('task-search').value.toLowerCase();
    const selectedTeam = document.getElementById('filter-team').value;
    const selectedUser = document.getElementById('filter-user').value;

    const allColumns = document.querySelectorAll('.kanban-column-content');
    
    allColumns.forEach(column => {
        const tasks = column.querySelectorAll('.task-card');
        let visibleCount = 0;

        tasks.forEach(task => {
            const title = task.dataset.taskTitle || '';
            const description = task.dataset.taskDescription || '';
            const taskTeams = (task.dataset.taskTeamIds || "").split(",").map(id => id.trim()).filter(x => x);
            const taskUser = task.dataset.taskUser || '';

            // Check search term
            const matchesSearch = !searchTerm || 
                                title.includes(searchTerm) || 
                                description.includes(searchTerm);

            // Check team filter
            const matchesTeam = !selectedTeam || taskTeams.includes(selectedTeam);

            // Check user filter
            const matchesUser = !selectedUser || taskUser === selectedUser;

            // Show/hide task based on all criteria
            if (matchesSearch && matchesTeam && matchesUser) {
                task.style.display = '';
                visibleCount++;
            } else {
                task.style.display = 'none';
            }
        });

        // Update "No tasks" message
        const noTasksMsg = column.querySelector('.no-tasks-msg');
        if (noTasksMsg) {
            noTasksMsg.style.display = visibleCount === 0 ? 'block' : 'none';
        }
    });
}


// Fullscreen Functionality
function initializeFullscreen() {
    const fullscreenBtn = document.getElementById('fullscreen-toggle');
    const kanbanBoard = document.getElementById('kanban-board');
    const pageHeader = document.getElementById('page-header');
    const navigationTabs = document.getElementById('navigation-tabs');
    const statsSection = document.getElementById('stats-section');

    fullscreenBtn.addEventListener('click', function() {
        const isFullscreen = kanbanBoard.classList.contains('kanban-fullscreen');
        
        if (isFullscreen) {
            // Exit fullscreen
            kanbanBoard.classList.remove('kanban-fullscreen');
            pageHeader.classList.remove('hidden');
            navigationTabs.classList.remove('hidden');
            statsSection.classList.remove('hidden');
            
            // Update button
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i> Fullscreen';
            fullscreenBtn.className = 'fullscreen-btn';
        } else {
            // Enter fullscreen
            kanbanBoard.classList.add('kanban-fullscreen');
            pageHeader.classList.add('hidden');
            navigationTabs.classList.add('hidden');
            statsSection.classList.add('hidden');
            
            // Update button
            fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i> Exit Fullscreen';
            fullscreenBtn.className = 'exit-fullscreen-btn';
        }
    });

    // ESC key to exit fullscreen
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && kanbanBoard.classList.contains('kanban-fullscreen')) {
            fullscreenBtn.click();
        }
    });
}
</script>

{% endblock %}