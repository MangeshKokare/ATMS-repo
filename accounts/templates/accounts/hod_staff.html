
{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Staff{% endblock %}

{% block content %}
<style>
    .staff-container {
        background: #f5f5f5;
        min-height: 100vh;
        padding: 2rem 0;
    }
    
    .page-header-card {
        background: #ffffff;
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 2px solid #e2e8f0;
    }
    
    .page-title {
        color: #2d3748;
        font-weight: 700;
        font-size: 2rem;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .page-title i {
        color: #0d6efd;
        font-size: 1.75rem;
    }
    
    .add-staff-btn {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .add-staff-btn:hover {
        transform: translateY(-2px);
    }
    
    .add-staff-btn i {
        margin-right: 0.5rem;
    }
    
    .upload-csv-btn {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .upload-csv-btn:hover {
        transform: translateY(-2px);
    }
    
    .upload-csv-btn i {
        margin-right: 0.5rem;
    }
    
    .form-card {
        background: #ffffff;
        border-radius: 20px;
        overflow: hidden;
        border: 2px solid #e2e8f0;
        margin-bottom: 2rem;
    }
    
    .form-card-header {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        padding: 1.5rem 2rem;
        border: none;
    }
    
    .form-card-header.csv-header {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    }
    
    .form-card-header h5 {
        margin: 0;
        font-weight: 600;
        font-size: 1.25rem;
    }
    
    .form-card-body {
        padding: 2.5rem;
        background: #f7fafc;
    }
    
    .form-section-divider {
        margin: 2rem 0;
        border: none;
        height: 2px;
        background: linear-gradient(to right, transparent, #e2e8f0, transparent);
    }
    
    .form-label-enhanced {
        font-weight: 600;
        color: #4a5568;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }
    
    .form-control-enhanced, .form-select-enhanced {
        padding: 0.875rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background-color: white;
    }
    
    .form-control-enhanced:focus, .form-select-enhanced:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1);
        background-color: white;
    }
    
    .form-select-enhanced[multiple] {
        min-height: 120px;
    }
    
    .form-select-enhanced[multiple] option {
        padding: 0.5rem;
        border-radius: 6px;
        margin: 2px 0;
    }
    
    .form-select-enhanced[multiple] option:checked {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        color: white;
    }
    
    .file-upload-area {
        border: 2px dashed #cbd5e0;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        background: #ffffff;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .file-upload-area:hover {
        border-color: #0d6efd;
        background: #e6f2ff;
    }
    
    .file-upload-area.dragover {
        border-color: #48bb78;
        background: #e6ffed;
    }
    
    .file-upload-icon {
        font-size: 3rem;
        color: #cbd5e0;
        margin-bottom: 1rem;
    }
    
    .file-upload-text {
        color: #4a5568;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    
    .file-upload-hint {
        color: #718096;
        font-size: 0.875rem;
    }
    
    .file-input-hidden {
        display: none;
    }
    
    .selected-file-info {
        display: none;
        background: #e6f2ff;
        border: 1px solid #0d6efd;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .selected-file-info.active {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .file-name {
        color: #0d6efd;
        font-weight: 600;
    }
    
    .btn-remove-file {
        background: #f56565;
        border: none;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-remove-file:hover {
        background: #e53e3e;
    }
    
    .csv-template-link {
        color: #0d6efd;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .csv-template-link:hover {
        color: #0a58ca;
        text-decoration: underline;
    }

    .alert-info {
        background: #e6f2ff;
        border: 1px solid #0d6efd;
        border-radius: 10px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
        color: #084298;
    }

    .alert-info code {
        background: rgba(13, 110, 253, 0.1);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-weight: 600;
        color: #0d6efd;
    }

    .alert-info small {
        display: block;
        margin-top: 0.5rem;
        color: #4a5568;
    }
    
    .btn-cancel {
        padding: 0.75rem 2rem;
        background: #e2e8f0;
        border: none;
        border-radius: 10px;
        color: #4a5568;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-cancel:hover {
        background: #cbd5e0;
        transform: translateY(-2px);
    }
    
    .btn-create {
        padding: 0.75rem 2rem;
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        border: none;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-create:hover {
        transform: translateY(-2px);
    }
    
    .table-card {
        background: #ffffff;
        border-radius: 20px;
        overflow: hidden;
        border: 2px solid #e2e8f0;
        padding: 1.5rem;
    }
    
    .enhanced-table {
        margin: 0;
        font-size: 0.9rem;
        width: 100% !important;
    }
    
    .enhanced-table thead th {
        background: #ffffff;
        color: rgb(0, 0, 0);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
        padding: 1rem;
        border: none;
        white-space: nowrap;
    }
    
    .enhanced-table tbody tr {
        transition: all 0.2s ease;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .enhanced-table tbody tr:hover {
        background-color: #f7fafc;
    }
    
    .enhanced-table tbody td {
        padding: 1rem;
        vertical-align: middle;
        color: #4a5568;
    }
    
    .badge-dept {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        color: white;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 0.25rem;
        margin-bottom: 0.25rem;
        display: inline-block;
    }
    
    .action-btn-group {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }
    
    .btn-edit {
        padding: 0.5rem 0.75rem;
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        border: none;
        border-radius: 8px;
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-edit:hover {
        transform: translateY(-2px);
    }
    
    .btn-save {
        padding: 0.5rem 0.75rem;
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        border: none;
        border-radius: 8px;
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-save:hover {
        transform: translateY(-2px);
    }
    
    .btn-delete {
        padding: 0.5rem 0.75rem;
        background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        border: none;
        border-radius: 8px;
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-delete:hover {
        transform: translateY(-2px);
    }
    
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #a0aec0;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1.5rem;
        opacity: 0.5;
    }
    
    .empty-state p {
        font-size: 1.1rem;
        margin: 0;
    }
    
    .info-helper {
        font-size: 0.8rem;
        color: #718096;
        margin-top: 0.25rem;
    }
    
    .info-helper i {
        color: #0d6efd;
    }

    .view-mode {
        display: inline-block;
    }

    .edit-mode {
        width: 100%;
    }

    .text-truncate {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .d-contents {
        display: contents;
    }

    /* DataTables custom styling */
    .dataTables_wrapper .dataTables_length select {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.5rem 2.5rem 0.5rem 0.75rem;
        margin: 0 0.5rem;
        min-width: 80px;
        background-color: white;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%234a5568' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 12px;
    }
    
    .dataTables_wrapper .dataTables_filter input {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        margin: 0 0.5rem;
        min-width: 200px;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
        border-radius: 6px;
        padding: 0.5rem 1rem !important;
        margin: 0 0.25rem;
        border: 1px solid #e2e8f0 !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%) !important;
        color: white !important;
        border: none !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: #f7fafc !important;
        border: 1px solid #0d6efd !important;
        color: #0d6efd !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%) !important;
        color: white !important;
    }

    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter {
        margin-bottom: 1rem;
    }

    .dataTables_wrapper .dataTables_length label,
    .dataTables_wrapper .dataTables_filter label {
        font-weight: 500;
        color: #4a5568;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .dataTables_wrapper .dataTables_info {
        color: #718096;
        font-weight: 500;
        padding-top: 1rem;
    }

    .dataTables_wrapper .dataTables_paginate {
        padding-top: 1rem;
    }
    
    @media (max-width: 768px) {
        .page-title {
            font-size: 1.5rem;
        }
        
        .form-card-body {
            padding: 1.5rem;
        }
        
        .action-btn-group {
            flex-direction: column;
        }
        
        .upload-csv-btn {
            margin-bottom: 0.5rem;
            margin-right: 0 !important;
        }
    }
</style>

<div class="staff-container">
    <div class="container-xl">

        <!-- Header Section -->
        <div class="page-header-card">
            <div class="row align-items-center">
                <div class="col-sm-6">
                    <h2 class="page-title">
                        <i class="fa fa-users"></i>
                        Manage <b>Staff</b>
                    </h2>
                </div>
                <div class="col-sm-6 text-end">
                    <button class="upload-csv-btn me-2" data-bs-toggle="collapse" data-bs-target="#uploadCsvForm" aria-expanded="false">
                        <i class="fa fa-upload"></i> Upload CSV
                    </button>
                    <button class="add-staff-btn" data-bs-toggle="collapse" data-bs-target="#addStaffForm" aria-expanded="false">
                        <i class="fa fa-user-plus"></i> Add New Staff
                    </button>
                </div>
            </div>
        </div>

        <!-- Upload CSV Form Card -->
        <div class="collapse" id="uploadCsvForm">
            <div class="form-card">
                <div class="form-card-header csv-header">
                    <h5><i class="fa fa-upload me-2"></i>Upload Staff CSV File</h5>
                </div>
                <div class="form-card-body">
                    <form method="POST" action="{% url 'accounts:upload_staff_csv' %}" enctype="multipart/form-data" id="csvUploadForm">
                        {% csrf_token %}
                        
                        <input type="hidden" name="campus" value="{{ campuses.first.id }}">
                        <input type="hidden" name="school" value="{{ schools.first.id }}">
                        {% for dept in departments %}
                            <input type="hidden" name="departments" value="{{ dept.id }}">
                        {% endfor %}

                        <!-- CSV Format Information -->
                        <div class="alert alert-info" role="alert">
                            <i class="fa fa-info-circle me-2"></i>
                            <strong>CSV Format Required:</strong> Your CSV file should have columns: 
                            <code>email</code>, <code>emp_id</code>, <code>phone_number</code>, <code>campus_name</code>, <code>school_name</code>, <code>department_names</code>
                            <small>Note: Separate multiple departments with semicolon (;)</small>
                            <br>
                            <a href="{% url 'accounts:download_staff_csv_template' %}" class="csv-template-link mt-2">
                                <i class="fa fa-download"></i>
                                <span>Download CSV Template</span>
                            </a>
                        </div>

                        <div class="mb-4">
                            <div class="file-upload-area" id="fileUploadArea">
                                <i class="fa fa-cloud-upload file-upload-icon"></i>
                                <p class="file-upload-text">Click to upload or drag and drop</p>
                                <p class="file-upload-hint">CSV file only (Max 5MB)</p>
                                <input type="file" name="csv_file" id="csvFileInput" class="file-input-hidden" accept=".csv" required>
                            </div>
                            
                            <div class="selected-file-info" id="selectedFileInfo">
                                <div>
                                    <i class="fa fa-file-csv me-2" style="color: #48bb78;"></i>
                                    <span class="file-name" id="fileName"></span>
                                </div>
                                <button type="button" class="btn-remove-file" id="removeFileBtn">
                                    <i class="fa fa-times"></i> Remove
                                </button>
                            </div>
                        </div>

                        <div class="d-flex gap-3 justify-content-end pt-3">
                            <button type="button" class="btn btn-cancel" data-bs-toggle="collapse" data-bs-target="#uploadCsvForm">
                                <i class="fa fa-times me-2"></i>Cancel
                            </button>
                            <button type="submit" class="btn btn-create" id="uploadCsvBtn" disabled>
                                <i class="fa fa-upload me-2"></i>Upload & Import
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Add Staff Form Card -->
        <div class="collapse" id="addStaffForm">
            <div class="form-card">
                <div class="form-card-header">
                    <h5><i class="fa fa-user-plus me-2"></i>Add New Staff</h5>
                </div>
                <div class="form-card-body">
                    <form method="POST" action="{% url 'accounts:hod_staff' %}">
                        {% csrf_token %}
                        
                        <!-- Personal Information Section -->
                        <div class="row g-4 mb-4">
                            <div class="col-lg-6">
                                <label class="form-label-enhanced">Email Address <span class="text-danger">*</span></label>
                                <input type="email" name="email" class="form-control form-control-enhanced" placeholder="Enter email address" required>
                                <small class="info-helper"><i class="fa fa-info-circle"></i> Email will be used as username</small>
                            </div>
                            <div class="col-lg-6">
                                <label class="form-label-enhanced">Employee ID <span class="text-danger">*</span></label>
                                <input type="text" name="emp_id" class="form-control form-control-enhanced" placeholder="Enter employee ID" required>
                            </div>
                        </div>

                        <div class="row g-4 mb-4">
                            <div class="col-lg-12">
                                <label class="form-label-enhanced">Phone Number <span class="text-danger">*</span></label>
                                <input type="text" name="phone_number" class="form-control form-control-enhanced" placeholder="Enter phone number"
                                       pattern="\d*" title="Phone number must contain only digits" required>
                            </div>
                        </div>

                        <hr class="form-section-divider">

                        <!-- Organization Information Section -->
                        <div class="row g-4 mb-4">
                            <div class="col-lg-4">
                                <label class="form-label-enhanced">Campus <span class="text-danger">*</span></label>
                                <select name="campus" id="newCampusSelect" class="form-select form-select-enhanced" required>
                                    <option value="">Select Campus</option>
                                    {% for campus in campuses %}
                                        <option value="{{ campus.id }}">{{ campus.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-lg-4">
                                <label class="form-label-enhanced">School <span class="text-danger">*</span></label>
                                <select name="school" id="newSchoolSelect" class="form-select form-select-enhanced" required>
                                    <option value="">Select Campus First</option>
                                </select>
                            </div>
                            <div class="col-lg-4">
                                <label class="form-label-enhanced">Department(s) <span class="text-danger">*</span></label>
                                <select name="department" id="newDepartmentSelect" class="form-select form-select-enhanced" multiple required>
                                    <option value="">Select School First</option>
                                </select>
                                <small class="info-helper"><i class="fa fa-info-circle"></i> Hold Ctrl/Cmd to select multiple</small>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex gap-3 justify-content-end pt-3">
                            <button type="button" class="btn btn-cancel" data-bs-toggle="collapse" data-bs-target="#addStaffForm">
                                <i class="fa fa-times me-2"></i>Cancel
                            </button>
                            <button type="submit" class="btn btn-create">
                                <i class="fa fa-check me-2"></i>Create Staff
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Staff Table -->
        {% if staff %}
        <div class="table-card">
            <table class="table enhanced-table align-middle" id="staffDataTable">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Emp ID</th>
                        <th>Phone</th>
                        <th>Campus</th>
                        <th>School</th>
                        <th>Departments</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in staff %}
                    <tr data-staff-id="{{ s.id }}">
                        <form method="POST" action="{% url 'accounts:update_staff' s.id %}" class="d-contents">
                            {% csrf_token %}

                            <!-- Email -->
                            <td>
                                <span class="view-mode text-truncate" style="max-width:180px; display:inline-block;">{{ s.email }}</span>
                                <input type="email" name="email" value="{{ s.email }}" class="form-control form-control-sm edit-mode d-none" required>
                            </td>

                            <!-- Emp ID -->
                            <td>
                                <span class="view-mode">{{ s.emp_id }}</span>
                                <input type="text" name="emp_id" value="{{ s.emp_id }}" class="form-control form-control-sm edit-mode d-none" required>
                            </td>

                            <!-- Phone -->
                            <td>
                                <span class="view-mode">{{ s.phone_number }}</span>
                                <input type="text" name="phone_number" value="{{ s.phone_number }}" class="form-control form-control-sm edit-mode d-none" pattern="\d*" required>
                            </td>

                            <!-- Campus -->
                            <td>
                                <span class="view-mode">{{ s.campus.name|default:"-" }}</span>
                                <select name="campus" class="form-select form-select-sm edit-mode d-none edit-campus-select" data-staff-id="{{ s.id }}" required>
                                    <option value="">Select Campus</option>
                                    {% for campus in campuses %}
                                    <option value="{{ campus.id }}" {% if s.campus.id == campus.id %}selected{% endif %}>{{ campus.name }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <!-- School -->
                            <td>
                                <span class="view-mode">{{ s.school.name|default:"-" }}</span>
                                <select name="school" class="form-select form-select-sm edit-mode d-none edit-school-select" data-staff-id="{{ s.id }}" required>
                                    <option value="">Select Campus First</option>
                                </select>
                            </td>

                            <!-- Departments -->
                            <td>
                                <span class="view-mode">
                                    {% if s.department.all %}
                                        {% for dept in s.department.all %}
                                            <span class="badge-dept">{{ dept.name }}</span>
                                        {% endfor %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </span>
                                <select name="department" class="form-select form-select-sm edit-mode d-none edit-department-select" data-staff-id="{{ s.id }}" multiple required style="min-height: 80px;">
                                    <option value="">Select School First</option>
                                </select>
                            </td>

                            <!-- Actions -->
                            <td class="text-center" style="white-space:nowrap;">
                                <div class="action-btn-group">
                                    <button type="button" class="btn btn-edit editBtn">
                                        <i class="fa fa-edit"></i>
                                    </button>
                                    <button type="submit" class="btn btn-save updateBtn d-none">
                                        <i class="fa fa-check"></i>
                                    </button>
                                    <a href="{% url 'accounts:delete_staff' s.id %}" class="btn btn-delete" onclick="return confirm('Are you sure you want to delete this staff?');">
                                        <i class="fa fa-trash"></i>
                                    </a>
                                </div>
                            </td>

                        </form>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="table-card">
            <div class="empty-state">
                <i class="fa fa-users"></i>
                <p>No staff found. Add your first staff member to get started!</p>
            </div>
        </div>
        {% endif %}

    </div>
</div>

<!-- Include DataTables CSS and JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // Store all schools and departments data
    const allSchools = [
        {% for school in schools %}
        {id: "{{ school.id }}", name: "{{ school.name }}", campus: "{{ school.campus.id }}"},
        {% endfor %}
    ];

    const allDepartments = [
        {% for dept in departments %}
        {id: "{{ dept.id }}", name: "{{ dept.name }}", school: "{{ dept.school.id }}"},
        {% endfor %}
    ];

    // Initialize DataTable (only if not already initialized)
    {% if staff %}
    if ($.fn.DataTable.isDataTable('#staffDataTable')) {
        $('#staffDataTable').DataTable().destroy();
    }
    const table = $('#staffDataTable').DataTable({
        pageLength: 10,
        responsive: true,
        order: [[0, 'asc']],
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Search staff...",
            lengthMenu: "Show _MENU_ entries"
        }
    });
    {% endif %}

    // CSV File Upload Functionality
    const fileUploadArea = document.getElementById('fileUploadArea');
    const csvFileInput = document.getElementById('csvFileInput');
    const selectedFileInfo = document.getElementById('selectedFileInfo');
    const fileName = document.getElementById('fileName');
    const removeFileBtn = document.getElementById('removeFileBtn');
    const uploadCsvBtn = document.getElementById('uploadCsvBtn');
    const csvUploadForm = document.getElementById('csvUploadForm');

    // Click to upload
    if (fileUploadArea && csvFileInput) {
        fileUploadArea.addEventListener('click', function() {
            csvFileInput.click();
        });

        // File selection handler
        csvFileInput.addEventListener('change', function(e) {
            handleFileSelect(e.target.files[0]);
        });

        // Drag and drop handlers
        fileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });
    }

    // Handle file selection
    function handleFileSelect(file) {
        if (!file) return;

        // Validate file type
        if (!file.name.endsWith('.csv')) {
            alert('Please upload a CSV file only.');
            csvFileInput.value = '';
            return;
        }

        // Validate file size (5MB limit)
        const maxSize = 5 * 1024 * 1024; // 5MB in bytes
        if (file.size > maxSize) {
            alert('File size exceeds 5MB limit. Please upload a smaller file.');
            csvFileInput.value = '';
            return;
        }

        // Display selected file
        fileName.textContent = file.name;
        selectedFileInfo.classList.add('active');
        fileUploadArea.style.display = 'none';
        
        // Enable upload button
        if (uploadCsvBtn) {
            uploadCsvBtn.disabled = false;
        }
    }

    // Remove file handler
    if (removeFileBtn) {
        removeFileBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Clear file input
            csvFileInput.value = '';
            
            // Hide selected file info
            selectedFileInfo.classList.remove('active');
            fileUploadArea.style.display = 'block';
            
            // Disable upload button
            if (uploadCsvBtn) {
                uploadCsvBtn.disabled = true;
            }
        });
    }

    // Form submission handler with validation
    if (csvUploadForm) {
        csvUploadForm.addEventListener('submit', function(e) {
            console.log('Form submitting...');
            console.log('File:', csvFileInput.files[0]);
            console.log('Form data:', new FormData(csvUploadForm));
            if (!csvFileInput.files || csvFileInput.files.length === 0) {
                e.preventDefault();
                alert('Please select a CSV file to upload.');
                return false;
            }

            // Show loading state
            if (uploadCsvBtn) {
                const originalText = uploadCsvBtn.innerHTML;
                uploadCsvBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Uploading...';
                uploadCsvBtn.disabled = true;

                // Optional: Reset button after form submission fails
                setTimeout(function() {
                    if (uploadCsvBtn.disabled) {
                        uploadCsvBtn.innerHTML = originalText;
                        uploadCsvBtn.disabled = false;
                    }
                }, 5000);
            }

            return true;
        });
    }

    // Reset form when collapse is hidden
    const uploadCsvFormCollapse = document.getElementById('uploadCsvForm');
    if (uploadCsvFormCollapse) {
        uploadCsvFormCollapse.addEventListener('hidden.bs.collapse', function() {
            // Reset form
            if (csvUploadForm) {
                csvUploadForm.reset();
            }
            
            // Reset file display
            if (csvFileInput) csvFileInput.value = '';
            if (selectedFileInfo) selectedFileInfo.classList.remove('active');
            if (fileUploadArea) fileUploadArea.style.display = 'block';
            
            // Disable upload button
            if (uploadCsvBtn) {
                uploadCsvBtn.disabled = true;
            }
        });
    }

    // Cascading dropdown function for Add Staff Form
    function setupNewStaffCascading() {
        const campusSelect = document.getElementById('newCampusSelect');
        const schoolSelect = document.getElementById('newSchoolSelect');
        const deptSelect = document.getElementById('newDepartmentSelect');

        if (!campusSelect || !schoolSelect || !deptSelect) return;

        campusSelect.addEventListener('change', function() {
            const selectedCampusId = this.value;
            
            // Reset and populate schools
            schoolSelect.innerHTML = '<option value="">Select School</option>';
            deptSelect.innerHTML = '<option value="">Select School First</option>';
            
            if (selectedCampusId) {
                const filteredSchools = allSchools.filter(s => s.campus === selectedCampusId);
                filteredSchools.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school.id;
                    option.textContent = school.name;
                    schoolSelect.appendChild(option);
                });
            }
        });

        schoolSelect.addEventListener('change', function() {
            const selectedSchoolId = this.value;
            
            // Reset and populate departments
            deptSelect.innerHTML = '';
            
            if (selectedSchoolId) {
                const filteredDepts = allDepartments.filter(d => d.school === selectedSchoolId);
                filteredDepts.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    deptSelect.appendChild(option);
                });
            } else {
                deptSelect.innerHTML = '<option value="">Select School First</option>';
            }
        });
    }

    // Setup cascading for edit mode in table
    function setupEditCascading(staffId) {
        const campusSelect = document.querySelector(`.edit-campus-select[data-staff-id="${staffId}"]`);
        const schoolSelect = document.querySelector(`.edit-school-select[data-staff-id="${staffId}"]`);
        const deptSelect = document.querySelector(`.edit-department-select[data-staff-id="${staffId}"]`);

        if (!campusSelect || !schoolSelect || !deptSelect) return;

        // Store original selections
        const originalSchool = schoolSelect.closest('td').querySelector('.view-mode').textContent.trim();
        const originalDeptElements = deptSelect.closest('td').querySelectorAll('.view-mode .badge-dept');
        const originalDepts = Array.from(originalDeptElements).map(el => el.textContent.trim());

        // Populate schools based on current campus
        function populateSchools(campusId, selectSchoolId = null) {
            schoolSelect.innerHTML = '<option value="">Select School</option>';
            const filteredSchools = allSchools.filter(s => s.campus === campusId);
            
            filteredSchools.forEach(school => {
                const option = document.createElement('option');
                option.value = school.id;
                option.textContent = school.name;
                if (school.name === originalSchool || school.id === selectSchoolId) {
                    option.selected = true;
                }
                schoolSelect.appendChild(option);
            });

            // Trigger department population if school is selected
            if (schoolSelect.value) {
                populateDepartments(schoolSelect.value);
            }
        }

        // Populate departments based on current school
        function populateDepartments(schoolId) {
            deptSelect.innerHTML = '';
            const filteredDepts = allDepartments.filter(d => d.school === schoolId);
            
            filteredDepts.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.name;
                if (originalDepts.includes(dept.name)) {
                    option.selected = true;
                }
                deptSelect.appendChild(option);
            });
        }

        // Initial population
        if (campusSelect.value) {
            populateSchools(campusSelect.value);
        }

        // Campus change event
        campusSelect.addEventListener('change', function() {
            const selectedCampusId = this.value;
            deptSelect.innerHTML = '<option value="">Select School First</option>';
            
            if (selectedCampusId) {
                populateSchools(selectedCampusId);
            } else {
                schoolSelect.innerHTML = '<option value="">Select Campus First</option>';
            }
        });

        // School change event
        schoolSelect.addEventListener('change', function() {
            const selectedSchoolId = this.value;
            
            if (selectedSchoolId) {
                populateDepartments(selectedSchoolId);
            } else {
                deptSelect.innerHTML = '<option value="">Select School First</option>';
            }
        });
    }

    // Edit/Update Toggle
    document.querySelectorAll(".editBtn").forEach(btn => {
        btn.addEventListener("click", function() {
            const tr = this.closest("tr");
            const staffId = tr.dataset.staffId;
            
            // Show edit mode
            tr.querySelectorAll(".view-mode").forEach(el => el.classList.add("d-none"));
            tr.querySelectorAll(".edit-mode").forEach(el => el.classList.remove("d-none"));
            this.classList.add("d-none");
            tr.querySelector(".updateBtn").classList.remove("d-none");
            
            // Setup cascading for this row
            setupEditCascading(staffId);
        });
    });

    // Initialize Add Staff Form cascading
    setupNewStaffCascading();
});
</script>

{% endblock %}