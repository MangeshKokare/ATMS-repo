{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load time_extras %}

{% block title %}Summary{% endblock %}

{% block content %}
<style>
    .task-action-btn[disabled],
    button[disabled] {
        opacity: 0.6 !important;
        cursor: not-allowed !important;
        pointer-events: none !important;
    }

    :root {
        --jira-blue: #0052cc;
        --jira-blue-light: #deebff;
        --jira-gray-100: #f4f5f7;
        --jira-gray-200: #ebecf0;
        --jira-gray-300: #dfe1e6;
        --jira-gray-700: #5e6c84;
        --jira-gray-900: #172b4d;
    }

    body {
        background-color: #fff;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }

    /* Header Section - Matching Board/Backlog */
    .summary-header {
        background-color: #fff;
        border-bottom: 2px solid var(--jira-gray-200);
        padding: 16px 24px;
        margin-bottom: 0;
    }

    .project-breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: var(--jira-gray-700);
        margin-bottom: 12px;
    }

    .project-breadcrumb .separator {
        color: var(--jira-gray-300);
    }

    .project-name {
        font-size: 24px;
        font-weight: 500;
        color: var(--jira-gray-900);
        margin: 0;
    }

    /* Navigation Tabs - Matching Board/Backlog */
    .summary-nav {
        display: flex;
        gap: 0;
        border-bottom: 2px solid var(--jira-gray-200);
        padding: 0 24px;
        background-color: #fff;
        margin-bottom: 24px;
    }

    .summary-nav-item {
        padding: 12px 16px;
        color: var(--jira-gray-700);
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
    }

    .summary-nav-item:hover {
        color: var(--jira-blue);
        background-color: var(--jira-gray-100);
    }

    .summary-nav-item.active {
        color: var(--jira-blue);
        border-bottom-color: var(--jira-blue);
    }

    /* Content Padding */
    .summary-content {
        padding: 0 24px 24px;
    }

    /* Enhanced Task Card Styles */
    .task-card {
        border-left: 4px solid #dee2e6;
        transition: all 0.3s ease;
        background: #fff;
    }
    
    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    }
    
    .task-card.todo-card { border-left-color: #ffc107; }
    .task-card.progress-card { border-left-color: #0d6efd; }
    .task-card.done-card { border-left-color: #198754; }
    
    /* Modern Button Styles */
    .task-action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 16px;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 8px;
        border: none;
        transition: all 0.2s ease;
        cursor: pointer;
        text-transform: none;
        gap: 6px;
        width: 100%;
    }
    
    .task-action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .task-action-btn:active {
        transform: translateY(0);
    }
    
    /* Specific Button Variants */
    .btn-move-progress {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .btn-move-progress:hover {
        background: linear-gradient(135deg, #5568d3 0%, #63408a 100%);
        color: white;
    }
    
    .btn-pause-task {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .btn-pause-task:hover {
        background: linear-gradient(135deg, #e082ea 0%, #e4465b 100%);
        color: white;
    }

    .btn-resume-task {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
    }
    
    .btn-resume-task:hover {
        background: linear-gradient(135deg, #32d86a 0%, #27e8c6 100%);
        color: white;
    }
    
    .btn-move-done {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }
    
    .btn-move-done:hover {
        background: linear-gradient(135deg, #3e9bed 0%, #00e1ed 100%);
        color: white;
    }
    
    .btn-back-progress {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
    }
    
    .btn-back-progress:hover {
        background: linear-gradient(135deg, #e95f89 0%, #edd02f 100%);
        color: white;
    }
    
    /* Button Icons */
    .task-action-btn i {
        font-size: 1rem;
    }
    
    /* Action Buttons Container */
    .task-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #e9ecef;
    }
    
    /* Task Info Styles */
    .task-info {
        font-size: 0.875rem;
        color: #6c757d;
        margin: 8px 0;
    }
    
    .task-info strong {
        color: #495057;
    }
    
    /* Column Headers */
    .kanban-column-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 16px;
        padding: 14px 12px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 8px;
        font-weight: 600;
        min-height: 50px;
        height: 50px;
        font-size: 1rem;
    }

    .kanban-column-header.todo { 
        background: linear-gradient(135deg, #ffe07b 0%, #ffad14 100%); 
        color: white;
    }

    .kanban-column-header.progress { 
        background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); 
        color: white; 
    }

    .kanban-column-header.done { 
        background: linear-gradient(135deg, #55efc4 0%, #00b894 100%); 
        color: white;
    }

    .kanban-column-header i {
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    .kanban-column-header span {
        white-space: nowrap;
        flex-shrink: 0;
    }

    /* Task Timer Badge */
    .task-timer-badge {
        display: inline-block;
        padding: 6px 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 8px;
    }

    .task-timer-badge.paused {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
</style>

<!-- Page Header -->
<div class="d-flex align-items-center mb-4">
    <h5 class="fw-bold mb-0 me-2">Project/Event</h5>
    <i class="fas fa-chevron-right text-muted"></i>
    <h5 class="fw-bold mb-0 ms-2 text-primary">
        {% if current_project %}
            {{ current_project.name }}
        {% else %}
            All Projects
        {% endif %}
    </h5>
</div>

<!-- Navigation Tabs -->
<div class="summary-nav">
    {% if request.user.role == 'hod' %}
        <a class="summary-nav-item {% if request.resolver_match.url_name == 'hod_dashboard' %}active{% endif %}"
            href="{% url 'accounts:hod_dashboard' %}?project={{ current_project.id }}">
            Summary
        </a>
    {% elif request.user.role == 'coordinator' %}
        <a class="summary-nav-item {% if request.resolver_match.url_name == 'coordinator_dashboard' %}active{% endif %}"
            href="{% url 'accounts:coordinator_dashboard' %}?project={{ current_project.id }}">
            Summary
        </a>
    {% else %}
    <a class="summary-nav-item {% if request.resolver_match.url_name == 'staff_dashboard' %}active{% endif %}" 
       href="{% url 'accounts:staff_dashboard' %}?project={{ current_project.id }}">
        Summary
    </a>
    {% endif %}
    <a class="summary-nav-item {% if active_tab == 'backlog' %}active{% endif %}" 
       href="{% url 'accounts:backlog_page' %}{% if current_project %}?project={{ current_project.id }}{% endif %}">
        Backlog
    </a>
    <a class="summary-nav-item {% if active_tab == 'board' %}active{% endif %}" 
       href="{% url 'accounts:board_page' %}{% if current_project %}?project={{ current_project.id }}{% endif %}">
        Board
    </a>
</div>

<!-- Content -->
<div class="summary-content">
    <!-- Top Stats + Status Overview -->
    <div class="row g-4 mb-4 align-items-stretch">
        <!-- Stats Cards -->
        <div class="col-lg-6 d-flex flex-column gap-2 h-100">
            <!-- First Row: Completed, Updated, In Review -->
            <div class="row g-2 mb-2">
                <div class="col-4">
                    <div class="card p-3 shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                        <i class="fas fa-clipboard-check fs-4 mb-1 text-success"></i>
                        <h5 class="card-title text-success mb-1">{{ completed_count }} Completed</h5>
                        <p class="card-text text-muted mb-0">in last 7 days</p>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card p-3 shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                        <i class="fas fa-sync fs-4 mb-1 text-primary"></i>
                        <h5 class="card-title text-primary mb-1">{{ updated_count }} Updated</h5>
                        <p class="card-text text-muted mb-0">in last 7 days</p>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card p-3 shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                        <i class="fas fa-eye fs-4 mb-1 text-warning"></i>
                        <h5 class="card-title text-warning mb-1">{{ in_review_count|default:0 }} In Review</h5>
                        <p class="card-text text-muted mb-0">awaiting review</p>
                    </div>
                </div>
            </div>

            <!-- Second Row: In Progress, Created, Due Soon, Done -->
            <div class="row g-2">
                <div class="col-3">
                    <div class="card p-3 shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                        <i class="fas fa-spinner fs-4 mb-1 text-info"></i>
                        <h5 class="card-title text-info mb-1">{{ in_progress_count|default:0 }} In Progress</h5>
                        <p class="card-text text-muted mb-0">currently ongoing</p>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card p-3 shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                        <i class="fas fa-plus-circle fs-4 mb-1 text-warning"></i>
                        <h5 class="card-title text-warning mb-1">{{ created_count|default:0 }} Created</h5>
                        <p class="card-text text-muted mb-0">in last 7 days</p>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card p-3 shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                        <i class="fas fa-calendar-times fs-4 mb-1 text-danger"></i>
                        <h5 class="card-title text-danger mb-1">{{ due_soon_count|default:0 }} Due Soon</h5>
                        <p class="card-text text-muted mb-0">in next 7 days</p>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card p-3 shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                        <i class="fas fa-check-circle fs-4 mb-1 text-success"></i>
                        <h5 class="card-title text-success mb-1">{{ done_count|default:0 }} Done</h5>
                        <p class="card-text text-muted mb-0">completed tasks</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Chart -->
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                    <h5 class="card-title mb-1"><i class="fas fa-tachometer-alt me-1"></i>Status Overview</h5>
                    <!-- Chart Canvas -->
                    <canvas id="statusChart" style="max-width:200px; max-height:120px;"></canvas>
                    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                    <script>
                        var ctx = document.getElementById('statusChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: ['To Do', 'In Progress', 'In Review', 'Done'],
                                datasets: [{
                                    data: [
                                        {{ todo_count|default:0 }},
                                        {{ in_progress_count|default:0 }},
                                        {{ in_review_count|default:0 }},
                                        {{ done_count|default:0 }}
                                    ],
                                    backgroundColor: [
                                        '#6c757d',  // Grey for To Do
                                        '#0d6efd',  // Blue for In Progress
                                        '#ffc107',  // Yellow for In Review
                                        '#198754'   // Green for Done
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { display: false }
                                },
                                maintainAspectRatio: false
                            }
                        });
                    </script>

                    <!-- Status Badges -->
                    <div class="mt-3 text-center d-flex justify-content-center gap-3 flex-wrap">
                        <span class="badge bg-secondary">To Do: {{ todo_count|default:0 }}</span>
                        <span class="badge bg-primary">In Progress: {{ in_progress_count|default:0 }}</span>
                        <span class="badge bg-warning text-dark">In Review: {{ in_review_count|default:0 }}</span>
                        <span class="badge bg-success">Done: {{ done_count|default:0 }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kanban Tasks -->
    <div class="row g-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-tasks me-1"></i>
                        {% if request.user.role == 'staff' %}All Tasks{% else %}Tasks{% endif %}
                    </h5>
                    {% if request.user.role == 'staff' %}
                    <p class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>
                        Tasks assigned to you (editable) and tasks you've created for others (view-only)
                    </p>
                    {% endif %}
                    <hr>
                    <div class="row">

                        <!-- To Do Column -->
                        <div class="col-md-4">
                            <div class="kanban-column-header todo">
                                <i class="fas fa-list"></i>
                                <span>Yet to Start</span>
                            </div>
                            {% for task in kanban_tasks.to_do %}
                                <div class="card mb-3 p-3 task-card todo-card">
                                    {% if request.user.role == 'staff' %}
                                    <!-- Badge for staff users -->
                                    <div class="mb-2">
                                        {% if task.assigned_to == request.user %}
                                            <span class="badge bg-primary">My Task</span>
                                        {% else %}
                                            <span class="badge bg-info">Created by Me</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    <h6 class="fw-bold mb-2">{{ task.title }}</h6>
                                    <p class="text-muted small mb-2">{{ task.description }}</p>
                                    <p class="task-info mb-0">
                                        <strong>Assigned to:</strong> 
                                        {% if task.team %}{{ task.team.name }}{% endif %}
                                        {% if task.assigned_to %} - {{ task.assigned_to.email }}{% endif %}
                                        {% if not task.team and not task.assigned_to %}Unassigned{% endif %}
                                    </p>

                                    <div class="task-actions">
                                        {% if request.user.role == 'staff' %}
                                            {% if task.assigned_to == request.user and not is_read_only %}
                                                <button type="button" class="task-action-btn btn-move-progress" onclick="startTask({{ task.id }})">
                                                    <i class="fas fa-play"></i>
                                                    <span>Start Working</span>
                                                </button>
                                            {% else %}
                                                <div class="alert alert-info small mb-0 text-center py-2">
                                                    <i class="fas fa-eye me-1"></i>View Only
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            {% if not is_read_only %}
                                            <button type="button" class="task-action-btn btn-move-progress" onclick="startTask({{ task.id }})">
                                                <i class="fas fa-play"></i>
                                                <span>Start Working</span>
                                            </button>
                                            {% else %}
                                            <button type="button" class="task-action-btn btn-move-progress" disabled title="Read only"> 
                                                <i class="fas fa-play"></i>
                                                <span>Read only</span>
                                            </button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            {% empty %}
                                <p class="text-muted text-center">No tasks</p>
                            {% endfor %}
                        </div>

                        <!-- In Progress Column -->
                        <div class="col-md-4">
                            <div class="kanban-column-header progress">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>In Progress</span>
                            </div>
                            {% for task in kanban_tasks.in_progress %}
                                <div class="card mb-3 p-3 task-card progress-card" 
                                     {% if request.user.role != 'staff' or task.assigned_to == request.user %}
                                     id="task-card-{{ task.id }}" 
                                     data-task-id="{{ task.id }}"
                                     data-start-time="{{ task.start_time|date:'c' }}"
                                     data-accumulated-time="{{ task.accumulated_time|default:0 }}"
                                     data-is-paused="{{ task.is_paused|default:'false' }}"
                                     data-pause-time="{{ task.pause_time|date:'c'|default:'' }}"
                                     {% endif %}>
                                    
                                    {% if request.user.role == 'staff' %}
                                    <!-- Badge for staff users -->
                                    <div class="mb-2">
                                        {% if task.assigned_to == request.user %}
                                            <span class="badge bg-primary">My Task</span>
                                        {% else %}
                                            <span class="badge bg-info">Created by Me</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    <h6 class="fw-bold mb-2">{{ task.title }}</h6>
                                    <p class="text-muted small mb-2">{{ task.description }}</p>
                                    <p class="task-info mb-0">
                                        <strong>Assigned to:</strong> 
                                        {% if task.team %}{{ task.team.name }}{% endif %}
                                        {% if task.assigned_to %} - {{ task.assigned_to.email }}{% endif %}
                                        {% if not task.team and not task.assigned_to %}Unassigned{% endif %}
                                    </p>

                                    <!-- Task Timer Display -->
                                    <div class="text-center my-2">
                                        {% if request.user.role == 'staff' and task.assigned_to != request.user %}
                                            <!-- Static timer for staff viewing created tasks -->
                                            <div class="task-timer-badge">
                                                <i class="fas fa-clock me-1"></i>
                                                <span>
                                                    {% if task.total_time %}
                                                        {{ task.total_time|format_duration }}
                                                    {% else %}
                                                        In Progress
                                                    {% endif %}
                                                </span>
                                            </div>
                                        {% else %}
                                            <!-- Live timer for own tasks -->
                                            <div class="task-timer-badge {% if task.is_paused %}paused{% endif %}" id="task-timer-{{ task.id }}">
                                                <i class="fas fa-clock me-1"></i>
                                                <span id="task-time-{{ task.id }}">0h 0m 0s</span>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- Subtasks -->
                                    {% if task.subtasks.all %}
                                        <div class="mt-3 mb-2">
                                            <small class="text-muted fw-bold">Subtasks:</small>
                                            {% for subtask in task.subtasks.all %}
                                                <div class="subtask d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded"
                                                    {% if request.user.role != 'staff' or task.assigned_to == request.user %}
                                                    id="subtask-{{ subtask.id }}"
                                                    data-subtask-id="{{ subtask.id }}"
                                                    data-task-id="{{ task.id }}"
                                                    data-time-spent="{{ subtask.time_spent_seconds|default:0 }}"
                                                    {% endif %}>
                                                    
                                                    <div>
                                                        <strong class="small">{{ subtask.title }}</strong><br>
                                                        <span class="badge bg-secondary" 
                                                              {% if request.user.role != 'staff' or task.assigned_to == request.user %}
                                                              id="timer-{{ subtask.id }}"
                                                              {% endif %}>
                                                            {{ subtask.time_spent_seconds|format_duration }}
                                                        </span>
                                                    </div>
                                                    
                                                    {% if request.user.role == 'staff' and task.assigned_to != request.user %}
                                                        <!-- No buttons for staff viewing created tasks -->
                                                    {% else %}
                                                        <div>
                                                            {% if not is_read_only %}
                                                                <button class="btn btn-sm btn-success" id="start-{{ subtask.id }}" 
                                                                    onclick="startSubtaskTimer({{ subtask.id }}, {{ subtask.time_spent_seconds|default:0 }})">
                                                                    <i class="fas fa-play"></i>
                                                                </button>
                                                                <button class="btn btn-sm btn-danger" id="stop-{{ subtask.id }}" 
                                                                    onclick="stopSubtaskTimer({{ subtask.id }})" disabled>
                                                                    <i class="fas fa-stop"></i>
                                                                </button>
                                                            {% else %}
                                                                <button class="btn btn-sm btn-success" disabled title="Read Only"><i class="fas fa-play"></i></button>
                                                                <button class="btn btn-sm btn-danger" disabled title="Read Only"><i class="fas fa-stop"></i></button>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}

                                    <div class="task-actions">
                                        {% if request.user.role == 'staff' %}
                                            {% if task.assigned_to == request.user %}
                                                <!-- User can edit their own tasks -->
                                                {% if not is_read_only %}
                                                    <button type="button" class="task-action-btn btn-pause-task" id="pause-btn-{{ task.id }}" onclick="pauseTask({{ task.id }})" {% if task.is_paused %}style="display: none;"{% endif %}>
                                                        <i class="fas fa-pause"></i>
                                                        <span>Pause Task</span>
                                                    </button>
                                                    <button type="button" class="task-action-btn btn-resume-task" id="resume-btn-{{ task.id }}" onclick="resumeTask({{ task.id }})" {% if not task.is_paused %}style="display: none;"{% endif %}>
                                                        <i class="fas fa-play"></i>
                                                        <span>Resume Task</span>
                                                    </button>
                                                    <form method="POST" action="{% url 'accounts:update_task_status' %}" onsubmit="return beforeComplete({{ task.id }})">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="task_id" value="{{ task.id }}">
                                                        <input type="hidden" name="new_status" value="done">
                                                        <input type="hidden" name="total_time" id="total-time-{{ task.id }}" value="0">
                                                        <button type="submit" class="task-action-btn btn-move-done">
                                                            <i class="fas fa-check"></i>
                                                            <span>Mark Complete</span>
                                                        </button>
                                                    </form>
                                                {% else %}
                                                    <button type="button" class="task-action-btn btn-pause-task" disabled title="Read only">
                                                        <i class="fas fa-pause"></i>
                                                        <span>Read only</span>
                                                    </button>
                                                {% endif %}
                                            {% else %}
                                                <!-- View-only for created tasks -->
                                                <div class="alert alert-info small mb-0 text-center py-2">
                                                    <i class="fas fa-eye me-1"></i>View Only
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <!-- Original logic for non-staff users -->
                                            {% if not is_read_only %}
                                                <button type="button" class="task-action-btn btn-pause-task" id="pause-btn-{{ task.id }}" onclick="pauseTask({{ task.id }})" {% if task.is_paused %}style="display: none;"{% endif %}>
                                                    <i class="fas fa-pause"></i>
                                                    <span>Pause Task</span>
                                                </button>
                                                <button type="button" class="task-action-btn btn-resume-task" id="resume-btn-{{ task.id }}" onclick="resumeTask({{ task.id }})" {% if not task.is_paused %}style="display: none;"{% endif %}>
                                                    <i class="fas fa-play"></i>
                                                    <span>Resume Task</span>
                                                </button>
                                                <form method="POST" action="{% url 'accounts:update_task_status' %}" onsubmit="return beforeComplete({{ task.id }})">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="task_id" value="{{ task.id }}">
                                                    <input type="hidden" name="new_status" value="done">
                                                    <input type="hidden" name="total_time" id="total-time-{{ task.id }}" value="0">
                                                    <button type="submit" class="task-action-btn btn-move-done">
                                                        <i class="fas fa-check"></i>
                                                        <span>Mark Complete</span>
                                                    </button>
                                                </form>
                                            {% else %}
                                                <button type="button" class="task-action-btn btn-pause-task" disabled title="Read only" {% if task.is_paused %}style="display:none;"{% endif %}>
                                                    <i class="fas fa-pause"></i>
                                                    <span>Read only</span>
                                                </button>
                                                <button type="button" class="task-action-btn btn-resume-task" disabled title="Read only" {% if not task.is_paused %}style="display:none;"{% endif %}>
                                                    <i class="fas fa-play"></i>
                                                    <span>Read only</span>
                                                </button>
                                                <button class="task-action-btn btn-move-done" disabled title="Read only">
                                                    <i class="fas fa-check"></i>
                                                    <span>Read only</span>
                                                </button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            {% empty %}
                                <p class="text-muted text-center">No tasks</p>
                            {% endfor %}
                        </div>

                        <!-- Done Column -->
                        <div class="col-md-4">
                            <div class="kanban-column-header done">
                                <i class="fas fa-check-circle"></i>
                                <span>Done</span>
                            </div>
                            {% for task in kanban_tasks.done %}
                                <div class="card mb-3 p-3 task-card done-card">
                                    {% if request.user.role == 'staff' %}
                                    <!-- Badge for staff users -->
                                    <div class="mb-2">
                                        {% if task.assigned_to == request.user %}
                                            <span class="badge bg-primary">My Task</span>
                                        {% else %}
                                            <span class="badge bg-info">Created by Me</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    <h6 class="fw-bold mb-2">{{ task.title }}</h6>
                                    <p class="text-muted small mb-2">{{ task.description }}</p>
                                    <p class="task-info mb-1">
                                        <strong>Assigned to:</strong> 
                                        {% if task.team %}{{ task.team.name }}{% endif %}
                                        {% if task.assigned_to %} - {{ task.assigned_to.email }}{% endif %}
                                        {% if not task.team and not task.assigned_to %}Unassigned{% endif %}
                                    </p>
                                    <p class="task-info mb-0">
                                        <strong>Total Time:</strong> 
                                        <span class="badge bg-success">{{ task.total_time|format_duration }}</span>
                                    </p>

                                    <div class="task-actions">
                                        {% if request.user.role == 'staff' %}
                                            {% if task.assigned_to == request.user %}
                                                <!-- User can reopen their own tasks -->
                                                {% if not is_read_only %}
                                                <form method="POST" action="{% url 'accounts:update_task_status' %}">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="task_id" value="{{ task.id }}">
                                                    <input type="hidden" name="new_status" value="in_progress">
                                                    <button type="submit" class="task-action-btn btn-back-progress">
                                                        <i class="fas fa-arrow-left"></i>
                                                        <span>Reopen Task</span>
                                                    </button>
                                                </form>
                                                {% else %}
                                                <button class="task-action-btn btn-back-progress" disabled title="Read only">
                                                    <i class="fas fa-arrow-left"></i>
                                                    <span>Read only</span>
                                                </button>
                                                {% endif %}
                                            {% else %}
                                                <!-- View-only for created tasks -->
                                                <div class="alert alert-success small mb-0 text-center py-2">
                                                    <i class="fas fa-check-circle me-1"></i>Completed
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <!-- Original logic for non-staff users -->
                                            {% if not is_read_only %}
                                            <form method="POST" action="{% url 'accounts:update_task_status' %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="task_id" value="{{ task.id }}">
                                                <input type="hidden" name="new_status" value="in_progress">
                                                <button type="submit" class="task-action-btn btn-back-progress">
                                                    <i class="fas fa-arrow-left"></i>
                                                    <span>Reopen Task</span>
                                                </button>
                                            </form>
                                            {% else %}
                                            <button class="task-action-btn btn-back-progress" disabled title="Read only">
                                                <i class="fas fa-arrow-left"></i>
                                                <span>Read only</span>
                                            </button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            {% empty %}
                                <p class="text-muted text-center">No tasks</p>
                            {% endfor %}
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

{% if is_read_only %}
<script>
    // Prevent all task actions for Coordinators
    function startTask(){ return; }
    function pauseTask(){ return; }
    function resumeTask(){ return; }
    function beforeComplete(){ return false; }

    // Prevent subtask actions
    function startSubtaskTimer(){ return; }
    function stopSubtaskTimer(){ return; }
</script>
{% endif %}

<script>
// Store task timers and their states
const taskTimers = {};
const subtaskTimers = {};

// Start a task (move from Yet to Start to In Progress)
function startTask(taskId) {
    fetch("{% url 'accounts:start_task_timer' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `task_id=${taskId}`
    })
    .then(r => r.json())
    .then(data => { if (data.success) location.reload(); });
}

// Pause task timer
function pauseTask(taskId) {
    if (taskTimers[taskId]) clearInterval(taskTimers[taskId].intervalId);

    const card = document.querySelector(`[data-task-id="${taskId}"]`);
    const totalTime = calculateCurrentTime(card);

    fetch("{% url 'accounts:pause_task_timer' %}", {
        method: 'POST',
        headers:{
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body:`task_id=${taskId}&accumulated_time=${totalTime}`
    }).then(r => r.json()).then(data=>{
        if(data.success){
            document.getElementById(`pause-btn-${taskId}`).style.display='none';
            document.getElementById(`resume-btn-${taskId}`).style.display='block';
            const badge=document.getElementById(`task-timer-${taskId}`);
            badge.classList.add('paused');
            card.dataset.isPaused='true';
            card.dataset.accumulatedTime=totalTime;
            card.dataset.startTime='';
        }
    });
}

// Resume task timer
function resumeTask(taskId){
    fetch("{% url 'accounts:resume_task_timer' %}",{
        method:'POST',
        headers:{
            'Content-Type':'application/x-www-form-urlencoded',
            'X-CSRFToken':getCookie('csrftoken')
        },
        body:`task_id=${taskId}`
    }).then(r=>r.json()).then(data=>{
        if(data.success){
            document.getElementById(`pause-btn-${taskId}`).style.display='block';
            document.getElementById(`resume-btn-${taskId}`).style.display='none';

            const badge=document.getElementById(`task-timer-${taskId}`);
            badge.classList.remove('paused');

            const card=document.querySelector(`[data-task-id="${taskId}"]`);
            card.dataset.isPaused='false';
            card.dataset.startTime=data.start_time;

            startTimerInterval(taskId);
        }
    });
}

function calculateCurrentTime(card){
    const startTime=card.dataset.startTime;
    const accumulatedTime=parseInt(card.dataset.accumulatedTime)||0;
    const isPaused=card.dataset.isPaused==='true';

    if(isPaused || !startTime) return accumulatedTime;

    const start=new Date(startTime);
    const now=new Date();
    return accumulatedTime + Math.floor((now-start)/1000);
}

function updateTaskTimer(taskId){
    const card=document.querySelector(`[data-task-id="${taskId}"]`);
    if(!card) return;

    const total=calculateCurrentTime(card);
    const timeElement = document.getElementById(`task-time-${taskId}`);
    if(timeElement) {
        timeElement.innerText = formatDuration(total);
    }
}

function startTimerInterval(taskId){
    if(taskTimers[taskId]) clearInterval(taskTimers[taskId].intervalId);
    taskTimers[taskId]={ intervalId:setInterval(()=>updateTaskTimer(taskId),1000) };
}

document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('.progress-card').forEach(card=>{
        const taskId = card.dataset.taskId;
        if(!taskId) return;

        updateTaskTimer(taskId);
        if(card.dataset.isPaused!=='true') startTimerInterval(taskId);
    });
});

function beforeComplete(taskId){
    const card=document.querySelector(`[data-task-id="${taskId}"]`);
    const total=calculateCurrentTime(card);
    document.getElementById(`total-time-${taskId}`).value=total;
    return true;
}

function startSubtaskTimer(subtaskId, seconds){
    const timerEl=document.getElementById(`timer-${subtaskId}`);
    if(!timerEl) return;
    
    seconds=parseInt(seconds);
    subtaskTimers[subtaskId]=setInterval(()=>{
        seconds++;
        timerEl.innerText=formatDuration(seconds);
    },1000);
}

function stopSubtaskTimer(subtaskId){
    clearInterval(subtaskTimers[subtaskId]);
    const timerEl = document.getElementById(`timer-${subtaskId}`);
    if(!timerEl) return;
    
    const timeStr=timerEl.innerText;
    const seconds=parseDurationToSeconds(timeStr);

    fetch("{% url 'accounts:update_subtask_time' %}",{
        method:'POST',
        headers:{
            'Content-Type':'application/x-www-form-urlencoded',
            'X-CSRFToken':getCookie('csrftoken')
        },
        body:`subtask_id=${subtaskId}&time_spent=${seconds}`
    });
}

function formatDuration(totalSeconds){
    const h=Math.floor(totalSeconds/3600);
    const m=Math.floor((totalSeconds%3600)/60);
    const s=totalSeconds%60;
    if(h>0) return `${h}h ${m}m ${s}s`;
    if(m>0) return `${m}m ${s}s`;
    return `${s}s`;
}

function parseDurationToSeconds(str){
    let t=0;
    const h=str.match(/(\d+)h/);
    const m=str.match(/(\d+)m/);
    const s=str.match(/(\d+)s/);
    if(h) t+=parseInt(h[1])*3600;
    if(m) t+=parseInt(m[1])*60;
    if(s) t+=parseInt(s[1]);
    return t;
}

function getCookie(name){
    let cookieValue=null;
    document.cookie.split(';').forEach(cookie=>{
        cookie=cookie.trim();
        if(cookie.startsWith(name+'=')){
            cookieValue = decodeURIComponent(cookie.substring(name.length+1));
        }
    });
    return cookieValue;
}
</script>

{% endblock %}